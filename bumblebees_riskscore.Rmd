---
title: "Farmland Biodiversity Health Index - <br> Bee Risk Scores"
author: "Elin Falla"
output:
  html_document: default
  pdf_document: default
  word_document: default
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Introduction**

This script calculates **risk scores** associated with **changes to farm management**. It does this for pollinators, subset here for just **bees**, considering only those species which use farmland.  
The method is from Butler, S. J. et al. 'A cross-taxonomic index for quantifying the health of farmland biodiversity.' J. Appl. Ecol. 46, 1154-1162 (2009) https://doi.org/10.1111/j.1365-2664.2009.01709.x  

This risk assessment framework assumes that the major mechanisms of impact on UK farmland bees will be:  
1. reduced forage plant abundance ($P$)   
2. reduced foraging activity due to loss of habitat ($F$)  
3. reduced nesting success ($N$)  

The method calculates risk based on the overlaps between the resource requirements used by each species and the resource requirements affected by the change.

&nbsp;

The risk score is calculated as follows: 

$$Risk Score = \frac{(P_t + F_t + N_t)} {R}$$  

where $P_t$ is the risk score associated with reduced foraging activity potential, $F_t$ is the risk score associated with the reduction in forage plant availability, $N_t$ is the risk score associated with reduced nest site availability and $R$ is the species’ reliance on farmland habitat.

&nbsp;

$P_t$ is calculated as follows:  
$$P_t = \frac{G_t}{G*H}$$

$G_t$ = total number of generations of the species' given life stage (i.e. $G_{ta}$ for adults, $G_{tl}$ for larvae) active in the activity periods affected
$G$ = number of generations of the life stage across all activity periods (i.e. per year)
$H$ = number of habitat components used by the species' life stage  

-----  

$F_t$ is calculated as follows:  
$$N_t = \frac{A}{F}$$
$A$ = number of points of coincidence between impact on and species life stage's use of forage plant families  
$F$ = number of points of coincidence between species life stage's habitat use and the location of its forage plants  

-----

$N_t$ is calculated as follows:  
$$N_t = \frac{B}{N * H_n}$$  
$B$ = number of points of coincidence between impact on and species use of nest sites
$N$ = number of nest sites
$H_n$ = number of habitats used where nest sites are likely to occur


## Set-up
### Load packages
```{r load-packages, message=FALSE}

rm(list = ls()) # clear env
library(readxl) # for reading in Excel sheets
library(tidyverse) # for data manipulation

```


### Source functions to calculate $P_t$ and $F_t$
Includes functions to calculate G, H, Gt, A, and F, as well as Pt and Ft.  
``` {r source-Pt-Ft}
source("calc_Pt_Ft_functions.R")
```


### Read in required datasets  
Load datasets and replace all NAs with 0s.  
``` {r read-in-data}

# farm management strategies
man_strats <- read_xlsx("change.xlsx", 1, skip=1) 
man_strats <- man_strats[1:6,] # select only butler strategies

# butterfly requirements matrix data
bee <- read_xlsx("Pollinator_requirements.xlsx") 
# bumblebee <- bumblebee %>%
#   filter(grepl("Bombus", species)) # select only bumblebee species

bee_plants <- bee %>%
  select(species, plants_start:plants_end)

# forage plant locations
plant_locs <- read_xlsx("forage_plant_location.xlsx", na="NA")

# replace NAs with 0s in all datasets
man_strats <- man_strats %>% 
  mutate_all(~replace(., is.na(.), 0))

bee <- bee %>% 
  mutate_all(~replace(., is.na(.), 0))

plant_locs <- plant_locs %>% 
  mutate_all(~replace(., is.na(.), 0))

bee_plants <- bee_plants %>% 
  mutate_all(~replace(., is.na(.), 0))

```

## Data preparation

``` {r data-prep}
# alphabetise plant families in plant_locs and in bee_plants (so they align correctly)
bee_plants <- bee_plants %>%
  select(species:plants_start, 
         sort(colnames(.[,-ncol(bee_plants)])), # sort plant columns alphabetically, not including last (plants_end) col
         plants_end)

plant_locs <- plant_locs[order(plant_locs$plantfamily),]

# extract plant families for plant_locs and bee_plants
plant_fams <- plant_locs %>% pull(plantfamily)
bee_plant_fams <- bee_plants %>% 
  select(plants_start:plants_end, -c(plants_start,plants_end)) %>% 
  colnames(.) 

# find plant families that are in plant_locs but not bee_plants
not_bee_plants <- 0
for (plant in plant_fams) {
  if (!(plant %in% bee_plant_fams)) {
    not_bee_plants <- c(not_bee_plants, plant)
  }
}
not_bee_plants <- not_bee_plants[-1]

# subset plant family locations to not include plant families bees don't forage on
for (i in not_bee_plants) {
  plant_locs <- plant_locs %>%
    filter(plantfamily != i)
}

# find plant families that are in bee_plants but not plant_locs
not_farm_plants <- 0
for (plant in bee_plant_fams) {
  if(!(plant %in% plant_fams)) {
    not_farm_plants <- c(not_farm_plants, plant)
  }
}
not_farm_plants <- not_farm_plants[-1]

# subset bee forage plants to not include those that aren't relevant (e.g. not on farmland, not present in UK)
bee_plants <- bee_plants %>%
  select(-all_of(not_farm_plants))

```

## Calculate $P_t$

### Calculate $G$ and $H$
$G$ = number of generations across all activity periods (ie. number of generations per year)  
$H$ = number of habitat components used by the species 

### Calculate $G_t$
$G_t$ = number of generations of a species active in the activity periods affected

Here, 'strat' is a single management strategy - i.e. one row of the management strategy data frame.


### Calculate Pt
Pta = Gta/(Ga*Ha)
Ptl = Gtl/(Gl*Hl)

function = calculate_Pt()

## Calculate $F_t$ (for $a$ and $l$)

### Calculate $F$ and $A$
$F$ = points of coincidence between species habitat use and the location of its forage plants 
$A$ = number of points of coincidence between the impact on and species’ use of forage plant families


### Calculate $F_t$
function = calculate_Ft()

## Calculate $N_t$

$N_t$ = risk score associated with reduced nesting site availability 

$$N_t = \frac{B}{(N * H_n)}$$ 
where  
$B$  = number of points of coincidence between the impact on and species' use of nest sites  
$N$  = number of nest sites used  
$H_n$ = number of habitats used where nest sites are likely to occur  

### Calculate $N$ and $H_n$
``` {r calc-N}
calculate_N_Hn <- function(data) {
  
  nest_sites <- c("Versatile", "Aerial", "Bare", "Extensive", "Open")
  N <- 0
  
  for (site in 1:length(nest_sites)) {
    site_count <- data %>% 
      select(contains(nest_sites[site])) %>%
      mutate(count = rowSums(.) | 0)
    
    N <- N + site_count$count
  }
  
  nest_habitats <- c("H_N", "M_N", "CG_N", "CA_N")
  Hn <- 0
  
  for (hab in 1:length(nest_habitats)) { 
    hab_count <- data %>%
      select(contains(nest_habitats[hab])) %>%
      mutate(count = rowSums(.) | 0)
    
    Hn <- Hn + hab_count$count
  }
  
  return(data.frame(N, Hn))
}
```

``` {r test-N-Hn}
calculate_N_Hn(bee)
```
### Calculate $B$


``` {r calc-b}
calculate_B <- function(data, strat) {
  
  nesting <- data %>% 
    select(nest_start : nest_end) %>%
    select(-c(nest_start, nest_end))
  
  nesting_effects <- strat %>%
    select(nest_start : nest_end) %>%
    select(-c(nest_start, nest_end))
  
  overlap <- as.data.frame(t(apply(nesting, 1, function(row) row & nesting_effects)))
  
  B <- rowSums(overlap)
  
  return(B)
}
```

``` {r test-B}
calculate_B(bee, man_strats[3,])
```

### Calculate $N_t$
$$N_t = \frac{B}{N * H_n}$$ 

``` {r calc-Nt}
calculate_Nt <- function(data, strat) {
  
  N_Hn <- calculate_N_Hn(data)
  N <- N_Hn$N
  Hn <- N_Hn$Hn
  
  B <- calculate_B(data, strat)

  # CALCULATE Nt
  Nt <- B / (N * Hn)

  # replace infinite or NA values with 0
  Nt <- 
    ifelse(
      is.nan(Nt) | is.infinite(Nt) == T,  # test
      0, # if yes
      Nt  # if no
    )
  
  return(Nt)
}
```

``` {r test-Nt}
calculate_Nt(bee, man_strats[2,])
```

``` {r}
# butt <- c("Aceraceae",	"Amaryllidaceae",	"Aquifoliaceae",	"Araliaceae",	"Balsaminaceae",	"Berberidaceae",	"Betulaceae",	"Boraginaceae",	"Brassicaceae",	"Campanulaceae",	"Cannabaceae",	"Caprifoliaceae",	"Caryophyllaceae",	"Celastraceae",	"Compositae",	"Convolvulaceae",	"Cornaceae",	"Crops",	"Cruciferae",	"Cucurbitaceae",	"Dipsacaceae",	"Euphorbiaceae",	"Fabaceae",	"Fagaceae",	"Gentianaceae",	"Geraniaceae",	"Grossulariaceae",	"Hippocastanaceae",	"Hypericaceae",	"Iridaceae",	"Lamiaceae",	"Liliaceae",	"Linaceae",	"Lythraceae",	"Malvaceae",	"Oleaceae",	"Onagraceae", "Papaveraceae",	"Plantaginaceae",	"Poaceae",	"Polygonaceae",	"Primulaceae",	"Ranunculaceae",	"Resedaceae",	"Rhamnaceae",	"Rosaceae",	"Rubiaceae",	"Salicaceae",	"Scrophulariaceae",	"Solanaceae",	"Tiliaceae",	"Ulmaceae",	"Umbelliferae",	"Urticaceae",	"Valerianaceae",	"Violaceae")

# bum <- c("Aceraceae",	"Amaryllidaceae",	"Aquifoliaceae",	"Araliaceae",	"Balsaminaceae",	"Berberidaceae",	"Betulaceae",	"Boraginaceae",	"Brassicaceae",	"Campanulaceae",	'Caprifoliaceae',	'Caryophyllaceae',	'Celastraceae',	'Cistaceae',	'Compositae',	'Convolvulaceae',	'Cornaceae',	'Crassulaceae',	'Crops',	'Cucurbitaceae',	'Dipsacaceae',	'Ericaceae',	'Euphorbiaceae',	'Fabaceae',	'Fagaceae',	'Gentianaceae',	'Geraniaceae',	'Globulariaceae',	'Grossulariaceae',	'Hippocastanaceae',	'Hypericaceae',	'Iridaceae',	'Lamiaceae',	'Liliaceae',	'Linaceae',	'Lythraceae',	'Malvaceae',	'Oleaceae',	'Onagraceae', "Papaveraceae",	"Plantaginaceae",	"Plumbaginaceae",	"Polemoniaceae",	"Polygonaceae",	"Primulaceae",	"Ranunculaceae",	"Resedaceae",	"Rhamnaceae",	"Rosaceae",	"Rubiaceae",	"Salicaceae",	"Saxifragaceae",	"Scrophulariaceae",	"Solanaceae",	"Tiliaceae",	"Umbelliferae",	"Urticaceae",	"Valerianaceae",	"Violaceae")
# butt_only <- 0
# bum_only <- 0
# for (i in butt) {
#   if (i %in% bum) next
#   else {print(i); butt_only <- c(butt_only, i)}
# }
# for (i in bum) {
#   if (i %in% butt) next
#   else {print(i); bum_only <- c(bum_only, i)}
# }



```

## Calculate risk score
``` {r calc-riskscore}
calc_bee_riskscore <- function(data, plants, plant_locs, strategies) {
  
  # initialise riskscores dataframe, rows are species, cols are strategies
  riskscores <- data.frame(matrix(NA, 
                                  nrow = nrow(data), 
                                  ncol = nrow(strategies) + 1)) # +1 to add in species names
  # put species names in first col
  riskscores[,1] <- data[,1]
  
  # name columns of riskscores according to strategies
  strat_names <- strategies %>% pull(agric_change)
  colnames(riskscores) <- c("species", strat_names)
  
  # extract reliance (R) values for adults and larvae from butterfly data
  R <- data %>% 
    select(contains("reliance"))
  
  # CALCULATE RISK SCORES per strategy and store in riskscores dataframe
  for (strat in 1:nrow(strategies)) {
    
    # CALCULATE PT, FT AND NT
    Pt <- calculate_Pt(data, strategies[strat,])
    Ft <- calculate_Ft(data, plants, plant_locs, strategies[strat,])
    Nt <- calculate_Nt(data, strategies[strat,])
    
    # CALCULATE RISK SCORE
    riskscores[,strat+1] <- (Pt + Ft + Nt) / R
  }
  
  # calculate total risk for each species by summing risk across all strategies (if more than one strategy)
  if (nrow(strategies) > 1) {
    riskscores$total_risk <- rowSums(riskscores[,-1])
  }
  
  return(riskscores)
}
```


### Run risk scores
``` {r run-risk}
risk <- calc_bee_riskscore(bee, bee_plants, plant_locs, man_strats)
bombus <- risk %>%
  filter(grepl("Bombus", species))
bombus

butler_risk <- c(2.06,0.80,2.21,0.94,0.75,0.77,2.36,1.25,0.73,2.38,1.29,1.40,4.23,0.78)

butler <- data.frame(species = bombus$species,
                     butler_risk,
                     my_risk = round(bombus$total_risk, 2))
butler$same <- butler$butler_risk == butler$my_risk
butler$diff <- butler$butler_risk - butler$my_risk
butler

```
