---
title: "Farmland Biodiversity Health Index - <br> Bumblebee Risk Scores"
author: "Alexa Varah"
date: "18/06/2020"
output:
  html_document: default
  pdf_document: default
  word_document: default
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Introduction**

This script calculates **risk scores** associated with **changes to farm management**. It does this for pollinators, subset here for just **bumblebees**, considering only those species which use farmland.  
The method is from Butler, S. J. et al. 'A cross-taxonomic index for quantifying the health of farmland biodiversity.' J. Appl. Ecol. 46, 1154-1162 (2009) https://doi.org/10.1111/j.1365-2664.2009.01709.x  

This risk assessment framework assumes that the major mechanisms of impact on UK farmland bumblebees will be:  
1. reduced forage plant abundance ($P$)   
2. reduced foraging activity due to loss of habitat ($F$)  
3. reduced nesting success ($N$)  

The method calculates risk based on the overlaps between the resource requirements used by each species and the resource requirements affected by the change:

![<font size="1.5">**Figure 1.** Risk assessment concept. The hatched area indicates risk.</font>](overlaps picture.png)

&nbsp;

The risk score is calculated as follows: 

$$Risk Score = \frac{(P_t + F_t + N_t)} {R}$$  

where $P_t$ is the risk score associated with reduced foraging activity potential, $F_t$ is the risk score associated with the reduction in forage plant availability, $N_t$ is the risk score associated with reduced nest site availability and $R$ is the species’ reliance on farmland habitat.

&nbsp;

# **Set-up**

#### Load required packages

```{r Load-packages, message=FALSE}

rm(list = ls()) # make sure envt is clear
library(readxl) # for reading in Excel sheets
library(tidyverse) # for data manipulation (package includes dplyr, tidyr, stringr....)

```
&nbsp; 

#### Load data

```{r load-data, results='hide'}

# NB if using OneDrive, these files won't load if they are open

# forage plant locations
#fpl <- read_xlsx("C:/Users/varah.a/OneDrive - Natural History Museum/Black Grass Resistance #Initiative/Biodiversity/Risk/forage_plant_location.xlsx", 1)
fpl <- read_xlsx("forage_plant_location.xlsx", 1)

# farm management changes
#fmc <- read_xlsx("C:/Users/varah.a/OneDrive - Natural History Museum/Black Grass Resistance #Initiative/Biodiversity/Risk/change.xlsx", 1, skip = 1)
fmc <- read_xlsx("change.xlsx", 1, skip = 1)

# pollinator resource requirements (includes habitat, forage plant and nesting/life-cycle requirements; records binary reponse of use)
#poll <- read_xlsx("C:/Users/varah.a/OneDrive - Natural History Museum/Black Grass Resistance #Initiative/Biodiversity/Risk/Pollinator matrix.xlsx", 1)
poll <- read_xlsx("Pollinator matrix.xlsx", 1)

```
&nbsp; 

#### Process data  

The **farm management change** spreadsheet contains blanks. These are read in as NA so convert the NAs to zeroes.
```{r Remove-NAs}

fmc <- fmc %>% 
  
  mutate_all(~replace(., is.na(.), 0))

```

&nbsp;  

The **pollinator resource requirements** data also has NAs, plus it has more plants and bees than we need and a couple of extraneous columns. We'll create a subset of this data which will just contain **bumblebee resource requirements**. We need to: 

* Replace all NAs with zero (there are blank cells in the Excel sheet which are read in as NAs). 

* Extract just bumblebees (*Bombus* species).  

* Get rid of the last two columns (they are notes and data sources).

* Remove from the pollinator matrix plants which don't grow in the UK or are unlikely to be found on farmland:

  + *Celasteraceae* - it's not used by any of the pollinator species.

  + *Cistaceae* - Mediterranean region.
  
  + *Crops* - not a plant family (**N.B.** we may need to keep this in for analyses of other taxa, but not needed for bumblebees). 
  
  + *Globulariaceae* - not in the UK.  
  
  + *Polemoniaceae* - Probably a garden escape. Damp and rocky habitats, often close to habitation. Unlikely in UK farmland.  
  
  + *Saxifragaceae* - unlikely in most of UK farmland.  


```{r Create-bumblebee-requirements-matrix, results='hide'}

bb <- poll %>% 
  
  # remove the last two columns (we don't need them)
  select(-c("flightperiod", "generationssource")) %>%

  # replace NAs with zero
  replace(is.na(.), 0) %>% 
  
  # pull out the rows containing bumblebee species
  filter(grepl('Bombus', species)) %>% 
  
  # rename forage habitat columns so they are more meaningful
  rename(
    f_hedge = H_fhab, 
    f_margin = M_fhab,
    f_arablefields = CA_fhab,
    f_grassfields = CG_fhab
  ) %>%
  
  # replace the spaces in the species names with underscores
  mutate(species = gsub(" ", "_", species)) %>% 

  # remove obsolete plant families
  select(-c("Celasteraceae", "Cistaceae", "Crops", "Globulariaceae", "Polemoniaceae", "Saxifragaceae"))

# re-order plant family columns alphabetically for ease of inspection
bb <- bb[,c(names(bb)[which(colnames(bb)=="species"):which(colnames(bb)=="CG_damp plant")],
            sort(names(bb)[which(colnames(bb)=="Fabaceae"):which(colnames(bb)=="Balsaminaceae")]))]

rm(poll) # we won't need this again

```

This is what the first 6 rows and 7 columns our new **bumblebee requirements** matrix ('bb') looks like:

```{r Look-at-bb, echo=FALSE, message=FALSE, warning = FALSE}

head(bb[,1:7])

```

&nbsp; 

#### Create destination dataframe

Create a new dataframe, **riskbom**, to hold the variables necessary for calculating the risk scores. As we calculate each variable we'll add it to this dataframe, until finally we can calculate a risk score for each bumblebee species.

```{r Create-riskbom-dataframe}

riskbom = setNames(data.frame(matrix(ncol = 14, nrow = length(bb$species))), 
                c("species", "G", "Gt", "H", "Pt", "A", "F.", "Ft", "B", "N", "Hn", "Nt", "R", "risk_score"))

riskbom$species = bb$species

head(riskbom)

```

&nbsp; 

# **Calculate Risk Scores**

For each bumblebee species we can now estimate the risk posed by a change in farm management.  

First, add each species' reliance on farmland ($R$) into the new risk dataframe:
```{r R}

riskbom$R = with(bb,Reliance[match(riskbom$species,species)])

```


Next, specify the change you want to investigate.

```{r Select-change}

change = 'aut_sow' # specify the agricultural change

```

Now calculate the impact of the change on each of the three categories of resource requirement.


&nbsp;

## 1. Reduced forage plant abundance ($P_t$) 

$P_t$ = risk score associated with reduced foraging activity potential 

$$P_t = \frac{G_t}{(G * H)}$$  

where  
$G_t$ = the number of foraging habitats affected in the activity periods affected (*i.e.* per generation)  
$G$ = total number of life cycle components (*i.e.* the sum of the number of generations across all activity periods)  
$H$ = number of forage habitat components used by the species   
  
In other words, $P_t$ is the fraction of the total possible '*activity period x foraging habitat*' combinations that are affected by the management change.  

The assumption here, particularly when calculating $G_t$, is that *one activity period = one generation*. This is because bumblebee nests are typically active for 2 to 3 months, so each two-month activity period defined here (early, mid and late) will approximately represent one generation.

Activity periods:    
**Early** = April – May  
**Mid** = June – July  
**Late** = August – September  

We'll calculate each of the components of $P_t$ in turn.  
&nbsp;

### **Calculate $G$**
$G$ = total number of life cycle components (*i.e.* the sum of the number of generations across all activity periods)
&nbsp;

The number of active generations in a year can vary for some species, with more generations in warmer years or in more southerly areas of the UK. Where this is the case, we have used the higher number of generations.
&nbsp;

The number of generations is already given in the bumblebee requirements dataframe, so simply add it into the risk dataframe.
```{r G}

riskbom$G = with(bb,generations[match(riskbom$species,species)]) 

```  
&nbsp;  

### **Calculate $G_t$**
$G_t$ = the number of each generation's foraging habitats affected. 

<span style="color: grey;">**N.B.** Simon Butler defined $G_t$ as 'the number of generations of a species active in the activity periods affected'. I've altered it here after clarification from Simon Butler on how to calculate $G_t$. To me, $G_t$ is more accurately represented by the altered definition given above. Here is Simon's explanation:  
"[*B. sylvarum*] are active in the mid-season and, for loss of non-cropped habitat, there is a loss of foraging habitat in both margin and hedge compartments across all times of season. Thus, $G_t$ = 2 (loss of mid-season foraging in margin and hedge). For land drainage, the impact is only in margin compartment, thus $G_t$ = 1 (loss of mid-season foraging in margin)."</span>

To calculate $G_t$, we need to find the overlaps between  
(a) the activity period(s) affected by the management change, and  
(b) any foraging habitat used by a species *in those periods*.  
In other words, it's the overlap between any columns containing the words 'early', 'mid' or 'late' in both the bumblebee matrix and the change matrix.

```{r Extract-activity-periods}
# from the change matrix, extract columns containing information about activity periods and extract the change you're interested in

c_tpa <- fmc %>% 
  
  # extract just the change you're investigating
  filter(agric_change == change)%>%
  
  # extract the first column, plus any columns containing info on which time periods are affected by the change
  select(1,matches("early|mid|late"))

```

Then find the overlaps for each species.
```{r Gt}

bb$Gt = apply(bb[,match(colnames(c_tpa[-1])[which(apply(c_tpa[-1], 2, function(x) any(x == -1)))],names(bb)),drop=FALSE], 1, sum)

```

Finally, add $G_t$ into the risk dataframe.
```{r Gt-into-Risk}

riskbom$Gt = with(bb,Gt[match(riskbom$species,species)]) 

```

Clear up.
```{r Remove-ctpa}

#rm(c_tpa)

```

&nbsp;  

### **Calculate $H$**
$H$ = number of forage habitat components used by the species

Habitats are classified as:

* hedgerow  

* margin  

* within-field grass  

* within-field arable  

From the bumblebee requirements data, extract the habitats used by bumblebees for foraging.  
Count these habitats to get $H$.
```{r H}

bb_hab <- bb %>%  
 
  # Select the 1st column ('species') plus forage habitat columns (f_hedge, f_margin, f_arablefields, f_grassfields)
  select(1,matches("f_")) %>%
 
  # for each species, sum how many of the possible habitats are used by that species
  mutate(H = rowSums(.[2:5])
  )

```


Add $H$ into the risk dataframe.
```{r H-into-Risk}

riskbom$H = with(bb_hab,H[match(riskbom$species,species)])

```


Clear up.
```{r Remove-bb_hab}

rm(bb_hab)

```

&nbsp;  

#### So $P_t$ is...
```{r Pt}

riskbom$Pt = ifelse(
  is.nan(riskbom$Gt / (riskbom$G * riskbom$H)) | is.infinite(riskbom$Gt / (riskbom$G * riskbom$H)) == T, 
  0, 
  riskbom$Gt / (riskbom$G * riskbom$H) # Pt = Gt / (G*H)
  ) 

```
&nbsp;  

## 2. Reduced foraging activity due to loss of habitat ($F_t$)  

$F_t$ = risk score associated with reduced forage plant availability  

$$F_t = \frac{A}{F}$$
where  
$A$ = number of points of coincidence between the impact on and species' use of forage plant families  
$F$ = points of coincidence between habitat use by a species and the location of its forage plants  

In other words, $F_t$ is the fraction of the total potential forage plant availability that is impacted by the management change.


### **Calculate $F$**
$F$ = points of coincidence between habitat use by a species and the location of its forage plants    

First, create dataframes to work on.

Make a dataframe of the forage plant locations relevant to bumblebees.  

Remove the following forage plant rows from the forage plant location dataframe:

* *Cannabaceae* - they are wind pollinated 

* *Celasteraceae* - no records of *Bombus* spp foraging on it

* *Cruciferae* - it's just another name for Brassicaceae, which are already in the dataframe

* *Ulmaceae* - they are wind pollinated (https://www.sciencedirect.com/topics/agricultural-and-biological-sciences/ulmaceae)  

```{r Make-fploc}

fploc <- fpl %>% 
  
  # filter out plant family rows we don't want
  filter(!plantfamily %in% c("Cannabaceae", "Celasteraceae", "Cruciferae", "Ulmaceae"))%>% 
  
  # extract the first column plus columns of forage plant locations which are relevant to bumblebees
  select("plantfamily":"grassfields" ) 

rm(fpl) # we won't need this again

```


Make a dataframe of the bumblebee forage plants:

```{r Make-bb_fpl}

bb_fpl <- bb %>% 
  
  # pull out the bumblebee species column plus all the plant family columns
  select(c("species","Aceraceae":"Violaceae")) 

```

We need to remove from 'bb_fpl' the extra plant families that aren't found in the 'fpl' (forage plant location) dataframe:
 * Crassulaceae (although bumblebees forage on them, this family is very unlikely to be found in farmland)  
 * Ericaceae (although bumblebees forage on them, this family is very unlikely to be found in farmland)    
 * Plumbaginaceae (although bumblebees forage on them, this family grows right by the sea)  

```{r Refine-bb_fpl}

bb_fpl = bb_fpl %>%   
  select(-c("Crassulaceae", "Ericaceae","Plumbaginaceae"))

```


Make a dataframe of bumblebee forage habitat:

```{r Make-bb_fhab}

bb_fhab = bb %>%
  
  select(1,matches("f_")) %>%
  
  # rename forage habitat columns so they match those in bb_fplhab
  rename(
    hedge = f_hedge,
    margin = f_margin,
    arablefields = f_arablefields,
    grassfields = f_grassfields
    )

```


Check that there are the same number of plant families in both the forage plant location dataframe (bb_fplhab) and the bumblebee forage plants dataframe (bb_fpl). If there is no difference, 'setdiff' should return zero both times.

```{r Check-plant-families-match}

families_bbforageplants <- sort(colnames(bb_fpl[-1]))
families_location <- fploc$plantfamily
length(families_bbforageplants) # 50
length(families_location) # 50 
setdiff(families_bbforageplants,families_location)
setdiff(families_location,families_bbforageplants)

```


Now calculate $F$.

```{r F}

riskbom$F. <- sapply(seq_len(nrow(riskbom)), function(i){ # do the following function to all the rows in 'riskbom'
  
      # Sum all the overlaps returned by the following matches...
      sum(
                # Match the plant families used by Bombus_sylvarum 
                # (i.e. the column names of 'bb_fpl' where the bumblebee species has a 1) 
                # with the plant family column of 'fploc', 
                # and return the row index of those plant families
          fploc[match(colnames(bb_fpl)[which(bb_fpl[i,] == 1)],fploc$plantfamily) , 
                
                # Match the foraging habitats used by Bombus_sylvarum 
                # (i.e. the column names of 'bb_fhab' where the bumblebee species has a 1) 
                # with the habitat columns of 'fploc', 
                # and return the column index of those habitats
                match(colnames(bb_fhab)[which(bb_fhab[i,] == 1)], colnames(fploc))]
        )
  }
  )
  
```

Clear up.
```{r Clear-up}

rm(bb_fhab) # we need to use bb_fpl later so we don't remove it yet

```
&nbsp;  


### **Calculate $A$**

$A$ = number of points of coincidence between the impact on and species' use of forage plant families  

$A$ only considers the habitat affected by the change, and the species' use of forage plant families. A species' foraging habitat is not considered here.

First, work out which habitats are affected.
```{r Make-mc_fha}

# which habitats are affected?
hab_aff <- c_tpa %>% 

  # count the number of each type of habitat affected
  mutate (H_count = rowSums(.[grep("H_", names(.))], na.rm = TRUE),
          M_count = rowSums(.[grep("M_", names(.))], na.rm = TRUE),
          CA_count = rowSums(.[grep("CA_", names(.))], na.rm = TRUE),
          CG_count = rowSums(.[grep("CG_", names(.))], na.rm = TRUE)
          ) %>% 

  # assign 1 if a the habitat is affected by the change, 0 if it is not
  mutate(hedge = replace(H_count, H_count < 0, -1),
         margin = replace(M_count, M_count < 0, -1),
         arablefields = replace(CA_count, CA_count < 0, -1),
         grassfields = replace(CG_count, CG_count < 0, -1)) %>% 
  
  select (agric_change, hedge, margin, arablefields, grassfields)
  

#mc_fha <- fmc %>% 
  
 # filter(agric_change == change)%>%
 
  #{if("drainage" %in% change) select(.,1,matches("fhab|damp plant")) else select(.,1,matches("fhab"))} %>% 

  #rename(
    # rename forage habitat columns so they match the column names in the forage plant location dataframe (fploc)
   # hedge = H_fhab, 
   # margin = M_fhab,
   # arablefields = CA_fhab,
   # grassfields = CG_fhab
  #) 

## NB!!! To be able to assess the impact of land drainage, the damp plant columns will need to be re-named.

# now, for each species, I need to subset fploc by 
# (a) the column(s) from c_ha that has a -1 in it, and 
# (b) the rows which are the plants used by that bb species
# and then sum the total number of 1's in the whole df

# Match the plant families used by the first bb sp 
                # (i.e. the column names of 'bb_fpl' where the bumblebee species has a 1) 
                # with the plant family column of 'fploc', 
                # and return the row index of those plant families
fploc[match(colnames(bb_fpl)[which(bb_fpl[1,] == 1)], fploc$plantfamily) , # gives row indices of plant families used by bee
                
                # Match the foraging habitats affected 
                # (i.e. the column names of 'hab_aff' where the bumblebee species has a -1) 
                # with the habitat columns of 'bb_fplhab', 
                # and return the column index of those habitats
                match(colnames(hab_aff)[which(hab_aff[1,] == -1)], colnames(fploc))]
  

riskbom$A <- sapply(seq_len(nrow(riskbom)), function(i){ # do the following function to all the rows in 'riskbom'
  
      # Sum all the overlaps returned by the following matches...
      sum(
                # Match the plant families used by Bombus_sylvarum 
                # (i.e. the column names of 'bb_fpl' where the bumblebee species has a 1) 
                # with the plant family column of 'fploc', 
                # and return the row index of those plant families
          fploc[match(colnames(bb_fpl)[which(bb_fpl[i,] == 1)], fploc$plantfamily) , 
                
                # Match the foraging habitats affected 
                # (i.e. the column names of 'hab_aff' where the bumblebee species has a -1) 
                # with the habitat columns of 'bb_fplhab', 
                # and return the column index of those habitats
                match(colnames(hab_aff)[which(hab_aff[1,] == -1)], colnames(fploc))]
        )
  }
  )



```

Next, find out which forage plants grow in these affected habitats and add this as a new column to the forage plant location dataframe.

```{r Find-plants-affected}

#fploc$change_affects = apply(fploc[,match(colnames(c_ha[-1])[which(apply(c_ha[-1], 2, function(x) any(x == #-1)))],names(fploc)),drop=FALSE], 1, sum)

#rm(mc_fha)

```

Now get the plant families with a 1 in the 'change_affects' column of the **forage plant location** (fploc) dataframe .
Use these names to lookup the columns (plant families) in the **bumblebee forage plants** (bb_fpl) dataframe that are affected,
then ascribe a 1 to the bumblebee species that use those plants.

In short, subset the bb_fpl df by the plant families affected and calculate rowsums.

```{r A}

fploverlaps <- bb_fpl %>% 
  
  # pull out the bumblebee species column and the columns of plant families which are affected by the management change
  select(species,
         
         # find the plant families in 'fploc' which have a 1 in column 6 (i.e. find the plant families that are affected),
         # transpose it (t) so that it becomes a row rather than a column,
         # make sure they are stored as a vector (rather than as a dataframe),
         # then match these plant families to the columns of bb_fpl
         # and pull out just these columns
         match(as.vector(t(fploc[which(fploc[,6]==1), 1])),colnames(bb_fpl)))%>% 
  
  # count the number of affected plant families used by each species
  transmute(species, A = rowSums(select(., -species)))

# Then add this number into the Risk dataframe
riskbom$A = with(fploverlaps,A[match(riskbom$species,species)]) 

# we don't need these again
rm(fploverlaps) 
rm(bb_fpl)
rm(fploc)

```


&nbsp;  

#### So $F_t$ is...
```{r Ft}

riskbom$Ft = ifelse(is.nan(riskbom$A / riskbom$F.)==T, 0, riskbom$A / riskbom$F.) 

```

&nbsp;  

## 3. Reduced nesting success ($N_t$)  

$N_t$ = risk score associated with reduced nesting site availability 

$$N_t = \frac{B}{(N * H_n)}$$ 
where  
$B$  = number of points of coincidence between the impact on and species' use of nest sites  
$N$  = number of nest sites used  
$H_n$ = number of habitats used where nest sites are likely to occur  

Nesting requirements are split into nest *sites* and nesting *habitats* (i.e. the habitats used where nest sites are likely to occur). Nest sites are classified as follows:  

* versatile 

* extensive grass  

* open grass   

* aerial nester

* bare ground   

Nest sites can occur within more than one nesting habitat (Table 1).    
Note that the 'bare ground' nest site refers to bare ground on banks, paths and tracks. 'Aerial' nest sites are are those in stems, beetle holes or dead wood. 'Extensive grassland' provides forage for nest building, and 'open grassland' provides the actual nest site.
&nbsp;  

<font size="1.5">**Table 1.** Nesting habitats and the nest sites found within them.</font>
```{r Nesting-table, echo=FALSE, message=FALSE, warning = FALSE}
#install.packages("kableExtra")
library(knitr)
library(kableExtra)

nesting_tbl <- data.frame(
  Nesting.Habitats = c("Hedgerow", "Margin", "Grass fields (cropped area)", "Arable fields (cropped area)"),
  Nest.Sites.within.each.habitat = c(
    "versatile, bare ground, aerial",
    "versatile, bare ground, extensive grassland, open grassland", 
    "versatile, bare ground, extensive grassland, open grassland",
    "bare ground"
    )
  ) %>% 
  
  rename(
    "Nesting habitats" = "Nesting.Habitats",
    "Nest sites found in each habitat"= "Nest.Sites.within.each.habitat")

kable(nesting_tbl) %>%
  
  kable_styling(bootstrap_options = c("striped", "hover", "responsive", full_width = F, position = "left"))%>%
  column_spec(1, bold = T) %>% 
  column_spec(1, width = "10em")

```

&nbsp;  


### **Calculate $B$**
$B$ = number of points of coincidence between the impact on and species' use of nest sites.  

**N.B.** $B$ does not require consideration of the time periods affected.

Extract bumblebee nest sites from both the **bumblebee requirements** data and the **farm management change** data.  
Count the number of overlaps to get $B$ for each species.

```{r B}

## 1. Which habitats are affected by the management change? Any nesting habitats affected will have a -1 in the column.

mc_nhab <- fmc %>% 
  
  # extract the row relating to the change you're interested in
  filter(agric_change == change) %>%
  
  # extract the columns that contain data about which habitats are affected by the management change
  select(1,matches("early|mid|late")) %>%
  
  # count the number of each type of habitat affected
  mutate (H_count = rowSums(.[grep("H_", names(.))], na.rm = TRUE),
          M_count = rowSums(.[grep("M_", names(.))], na.rm = TRUE),
          CA_count = rowSums(.[grep("CA_", names(.))], na.rm = TRUE),
          CG_count = rowSums(.[grep("CG_", names(.))], na.rm = TRUE)
          ) %>% 

  # assign 1 if a the habitat is affected by the change, 0 if it is not
  mutate(H = replace(H_count, H_count < 0, -1),
         M = replace(M_count, M_count < 0, -1),
         CA = replace(CA_count, CA_count < 0, -1),
         CG = replace(CG_count, CG_count < 0, -1)) %>% 
  
  select (agric_change, H, M, CA, CG)
  

## 2. Of these affected habitats, 
## (a) which one(s) does each bumblebee species use for nest sites, and 
## (b) how many nest sites does a species use within that habitat?

bb_nsitehab <- bb %>% 

  # count the number of nest sites each species uses within each habitat
  mutate( H = rowSums(.[grep("H_N", names(.))], na.rm = TRUE),
          M = rowSums(.[grep("M_N", names(.))], na.rm = TRUE),
          CA = rowSums(.[grep("CA_N", names(.))], na.rm = TRUE),
          CG = rowSums(.[grep("CG_N", names(.))], na.rm = TRUE)
          ) %>% 
  
  # extract the species column plus the new columns created above 
  select (species, H:CG)


## 3. Work out the overlaps
bb_nsitehab$B = apply(bb_nsitehab[,match(colnames(mc_nhab[-1])[which(apply(mc_nhab[-1], 2, function(x) any(x == -1)))], names(bb_nsitehab)), drop=FALSE], 1, sum)


## 4. Add 'B' into the Risk dataframe
riskbom$B = with(bb_nsitehab,B[match(riskbom$species,species)])


## 5. Clear up
rm(bb_nsitehab)
rm(mc_nhab)

```

&nbsp;  


### **Calculate $N$**
$N$ = number of nest sites used  

```{r N}

bb_nsite <- bb %>%
  
  select (species, matches("_N_")) %>%
  
  # count how many of each type of nest site is used
  mutate( Versatile_count = rowSums(.[grep("_Versatile", names(.))], na.rm = TRUE),
          Aerial_count = rowSums(.[grep("_Aerial", names(.))], na.rm = TRUE),
          Bare_count = rowSums(.[grep("_Bare", names(.))], na.rm = TRUE),
          Extensive_count = rowSums(.[grep("_Extensive", names(.))], na.rm = TRUE),
          Open_count = rowSums(.[grep("_Open", names(.))], na.rm = TRUE)
          ) %>%
  
  # assign 1 if a species uses a nest site, 0 if it does not  
  mutate(Versatile = replace(Versatile_count, Versatile_count > 0, 1),
         Aerial = replace(Aerial_count, Aerial_count > 0, 1),
         Bare= replace(Bare_count, Bare_count > 0, 1),
         Extensive= replace(Extensive_count, Extensive_count > 0, 1),
         Open= replace(Open_count, Open_count > 0, 1)
         ) %>%
  
  select (species, Versatile, Aerial, Bare, Extensive, Open) %>%
  
  # count the total number of different types of nest site used by a species
  transmute(species, N = rowSums(select(., -species)) )

riskbom$N = with(bb_nsite,N[match(riskbom$species,species)]) # add the scores for N into the 'Risk' dataframe

rm(bb_nsite)

```
&nbsp;  

### **Calculate $H_n$**

$H_n$ = number of habitats used where nest sites are likely to occur.  

Habitats are classified as:

* hedgerow  

* margin  

* within-field grass  

* within-field arable  


```{r Hn}

bb_nhab = bb %>%
  
  # pull out just those columns useful to this calculation (i.e. the species column and all the nesting columns)
  select (species, matches("_N_")) %>%
  
  # sum across each type of nesting habitat
  mutate (H_count = rowSums(.[grep("H_N", names(.))], na.rm = TRUE),
          M_count = rowSums(.[grep("M_N", names(.))], na.rm = TRUE),
          CA_count = rowSums(.[grep("CA_N", names(.))], na.rm = TRUE),
          CG_count = rowSums(.[grep("CG_N", names(.))], na.rm = TRUE)
          ) %>% 

  # assign 1 if a the habitat is used for nesting, 0 if it is not
  mutate(H_used = replace(H_count, H_count < 0, -1),
         M_used = replace(M_count, M_count < 0, -1),
         CA_used = replace(CA_count, CA_count < 0, -1),
         CG_used = replace(CG_count, CG_count < 0, -1)) %>% 
  
  # pull out just these new 'use' columns so we can do rowsums on them
  select (species, H_used:CG_used) %>%
  
  # count the total number of different types of nesting habitat used by a species
  transmute(species, Hn = rowSums(select(., -species)) )


riskbom$Hn = with(bb_nhab,Hn[match(riskbom$species,species)]) # Add the scores for Hn into the 'Risk' dataframe

```
&nbsp;  

#### So $N_t$ is...

```{r Nt}

riskbom$Nt <- riskbom$B / (riskbom$N * riskbom$Hn)

```
&nbsp;  


## 4. Calculate Risk Score
**Risk = ( Pt + Ft + Nt ) / R**
```{r Risk-Score}

riskbom$risk_score <- ifelse(
  is.na( 
    (riskbom$Pt + riskbom$Ft + riskbom$Nt) / riskbom$R ) == T, 0, (riskbom$Pt + riskbom$Ft + riskbom$Nt) / riskbom$R 
  )

```

Now look at the risk score for *Bombus sylvarum* of changing from spring to autumn sowing (this species it 13th on the list).  
```{r Risk-for-B-sylvarum, eval=FALSE, echo=FALSE}
riskbom[13,]
```



```{r Superseded-Make bb_activity-df, echo=FALSE, message=FALSE, warning = FALSE}
#bb_activity <- bb %>% 
  
  # pull out just the columns we want
  #select("species","generations",matches("early|mid|late"))%>%
  
  # sum the number of habitats used early-season
  #mutate(earlycount = rowSums(.[grep("early", names(.))], na.rm = TRUE),
         
         # sum the number of habitats used mid-season
         #midcount = rowSums(.[grep("mid", names(.))], na.rm = TRUE),
         
         # sum the number of habitats used late-season
         #latecount = rowSums(.[grep("late", names(.))], na.rm = TRUE))%>% 
  
  # assign 1 if species is active early-season, 0 if not
  #mutate(early = replace(earlycount, earlycount>1, 1),
         
         # assign 1 if species is active mid-season, 0 if not       
         #mid = replace(midcount, midcount>1, 1),
         
         # assign 1 if species is active late-season, 0 if not
         #late = replace(latecount, latecount>1, 1))%>% 
  
  # pull out just the columns we'll need
  #select("species","early","mid","late")


```
```{r Superseded-Extract-time-periods-affected, eval=FALSE, echo=FALSE}
#mc_tpa <- fmc %>% 
  
  # choose the change you're investigating
  #filter(agric_change == 'aut_sow')%>% 
  
  # extract the first column, plus any columns containing info on which time periods are affected by the change
  #select(1,matches("early|mid|late"))%>% 
  
  # sum the number of habitats used early-season
  #mutate(earlycount = rowSums(.[grep("early", names(.))], na.rm = TRUE),
         
         # sum the number of habitats used mid-season
         #midcount = rowSums(.[grep("mid", names(.))], na.rm = TRUE),
         
         # sum the number of habitats used late-season
         #latecount = rowSums(.[grep("late", names(.))], na.rm = TRUE))%>% 
  
  # assign 1 if species is active early-season, 0 if not
  #mutate(early = replace(earlycount, earlycount>1, 1),
         
         # assign 1 if species is active mid-season, 0 if not       
         #mid = replace(midcount, midcount>1, 1),
         
         # assign 1 if species is active late-season, 0 if not
         #late = replace(latecount, latecount>1, 1))%>% 
  
  # extract just the columns 'early', 'mid' and 'late'
  #select("agric_change","early","mid","late")
```
```{r Superseded-Gt-calc, eval=FALSE, echo=FALSE}
#bb_activity$Gt = apply(bb_activity[,match(colnames(mc_tpa[-1])[which(apply(mc_tpa[-1], 2, function(x) any(x == #-1)))],names(bb_activity)),drop=FALSE], 1, sum)
```  
```{r Superseded-H, eval=FALSE, echo=FALSE}
#select(1,matches("f_|H_N|M_N|CA_N|CG_N")) %>% 
  ####select(1,matches("early|mid|late")) %>%  

 #sum rows across each of the forage habitat types
  #mutate(hedge = rowSums(.[grep("H_", names(.))], na.rm = TRUE),
  #       margin = rowSums(.[grep("M_", names(.))], na.rm = TRUE),
  #       arablefields = rowSums(.[grep("CA_", names(.))], na.rm = TRUE),
  #       grassfields = rowSums(.[grep("CG_", names(.))], na.rm = TRUE)
  #       ) %>% 
  # remove the raw data nesting habitat columns
  #select(-matches("H_|M_|CA_|CG_"))  %>%
  
  #  sum rows across each of the habitat types (this time it's habitats used for both nesting + foraging)
  #mutate(hedgecount = rowSums(.[grep("hedge", names(.))], na.rm = TRUE),
   #      margincount = rowSums(.[grep("margin", names(.))], na.rm = TRUE),
   #      arablefieldscount = rowSums(.[grep("arablefields", names(.))], na.rm = TRUE),
   #      grassfieldscount = rowSums(.[grep("grassfields", names(.))], na.rm = TRUE)
   #      )%>% 
  
  # remove columns we no longer need
  #select(-matches("f_|n_"))%>%
  
  # assign 1 if a species uses a habitat, 0 if it does not
  #mutate(hedge = replace(hedgecount, hedgecount>1, 1),
  #       margin = replace(margincount, margincount>1, 1),
  #       arablefields = replace(arablefieldscount, arablefieldscount>1, 1),
  #       grassfields = replace(grassfieldscount, grassfieldscount>1, 1)
  #       ) %>% 
  
  # remove the columns we no longer need
  #select(-c("hedgecount","margincount","arablefieldscount","grassfieldscount")
  #       ) %>%
  
  # sum across habitats to get the total number of habitats used by a species
  #mutate(H = rowSums(.[14:17])
  #       )

```
```{r Superseded-Activity-period-affected, eval=FALSE, echo=FALSE}
#1. Which time period does the change impact, and does the bee forage in those time periods?
#bb_activity <- bb_activity %>%
#  mutate(change_affected = rowSums(.[ match(colnames(change[-1])[which(colSums(change[-1])<0)],names(bb_activity)) ])) # finds the column index/indices in 'activity' that match column/s containing -1 in 'change', then rowsums across just these columns for each bee spp
                                                                                            #==-1

#nesting$change_affected = with(bb_activity,change_affected[match(nesting$species,species)]) # adds change_affected into df 'nesting'

```
```{r Superseded-Calculate-B, eval=FALSE, echo=FALSE}
#2. Now calculate B
#nesting$B <- ifelse( nesting$change_affected == 0 , # if the entry in change_affected is zero....
#                     0, # then B gets zero...
#                     rowSums(nesting[,match(str_remove(change[grep('nrqmt_', change$resource),][which(apply(change[grep('nrqmt_', change$resource),], #1, function(r) any(r %in% -1))),1],"nrqmt_"),names(nesting))])
                     ) # otherwise, if the entry in change_affected is NOT zero, sum across rows for those resource columns in 'nesting' which are affected by autumn sowing

#riskbom$B = with(nesting,B[match(riskbom$species,species)]) # adds B into df 'risk'

```
```{r Superseded-B, eval=FALSE, echo=FALSE}
# the below is the original script to calculate B. It's wrong.
# ******************************
#mc_nhab <- fmc %>% 
  
  #filter(agric_change == change)%>%
  
  #select(1,matches("_N_"))%>%
  
 # count the number of each type of nesting habitat used by each species
  #mutate (H_N_count = rowSums(.[grep("H_N_", names(.))], na.rm = TRUE),
   #       M_N_count = rowSums(.[grep("M_N_", names(.))], na.rm = TRUE),
    #      CA_N_count = rowSums(.[grep("CA_N_", names(.))], na.rm = TRUE),
     #     CG_N_count = rowSums(.[grep("CG_N_", names(.))], na.rm = TRUE)
      #    )%>% 

  # assign 1 if a species uses a habitat, 0 if it does not
  #mutate(n_hedge = replace(H_N_count, H_N_count < 0, -1),
   #      n_margin = replace(M_N_count, M_N_count < 0, -1),
    #     n_arablefields = replace(CA_N_count, CA_N_count < 0, -1),
     #    n_grassfields = replace(CG_N_count, CG_N_count < 0, -1))%>% 
  
  #select (agric_change, n_hedge, n_margin, n_arablefields, n_grassfields)
  

# do the same for the bumblebee requirements data
#bb_nhab <- bb %>%

  #select (species, matches("_N_"))%>%
  
  # count the number of nesting habitat types
  #mutate (H_N_count = rowSums(.[grep("H_N_", names(.))], na.rm = TRUE),
   #       M_N_count = rowSums(.[grep("M_N_", names(.))], na.rm = TRUE),
    #      CA_N_count = rowSums(.[grep("CA_N_", names(.))], na.rm = TRUE),
     #     CG_N_count = rowSums(.[grep("CG_N_", names(.))], na.rm = TRUE)
      #    )%>% 
  
  # assign 1 if a species uses a habitat, 0 if it does not  
  #mutate(n_hedge = replace(H_N_count, H_N_count > 0, 1),
   #      n_margin = replace(M_N_count, M_N_count > 0, 1),
    #     n_arablefields = replace(CA_N_count, CA_N_count > 0, 1),
     #    n_grassfields = replace(CG_N_count, CG_N_count > 0, 1))%>% 
  
  #select (species, n_hedge, n_margin, n_arablefields, n_grassfields)

# count the overlaps
#bb_nhab$B = apply(bb_nhab[,match(colnames(mc_nhab[-1])[which(apply(mc_nhab[-1], 2, function(x) any(x == -1)))],names(bb_nhab)),drop=FALSE], 1, sum)

# add the score for B into the Risk dataframe
#riskbom$B = with(bb_nhab, B[match(riskbom$species, species)])
```
```{r remove-spaces&text-Prev-used-in-B, eval=FALSE, echo=FALSE}
# remove spaces in colnames
# %>% rename_at(vars(everything()), ~str_replace_all(., "\\s+", "")) 
# get rid of all text after and including the first underscore, to leave only the habitat (so it matches the habitat affected in mc_nhab)
#names(bb_nsite) = sub("_.*","",names(bb_nsite))  

```

