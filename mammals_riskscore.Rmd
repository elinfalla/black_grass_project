---
title: "Farmland Biodiversity Health Index - <br> Mammal Risk Scores"
author: "Elin Falla"
output:
  html_document: default
  pdf_document: default
  word_document: default
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set-up
```{r load-packages, message=FALSE}

rm(list = ls()) # clear env
library(readxl) # for reading in Excel sheets
library(tidyverse) # for data manipulation

```


## Read in required datasets  
``` {r read-in-data}
man_strats <- read_xlsx("change.xlsx", 3) # farm management strategies

mammals <- read_xlsx("Mammal matrix.xlsx", skip = 2) # mammal data

```

## Replace NAs with 0s in both datasets
``` {r replace-na}
man_strats <- man_strats %>% 
  mutate_all(~replace(., is.na(.), 0))

mammals[is.na(mammals)] <- 0
```

The risk score is calculated as follows: 
Risk score = (Dt + Nt) / R  
where:  
* Dt = A/(D*F) + B/F  
* Nt = C1/N + C2/N  

## First calculate Dt  

### Calculate F and D
``` {r calc-D}
calculate_F_D <- function(data) {
  F <- data %>%
    select(C_hab:R_hab) %>%
    rowSums(.)
  
  D_temp <- data %>% 
    select(C_BG:R_vertebrate) %>%  # select all dietary components cols
    rowSums(.) # sum for each species
  
  D <- ceiling(D_temp / F)  # divide each value by value of F for the species to get D. then round up to account for R_AQ
  
  return(data.frame(F,D))
}
```

### Calculate A and B
Remember, in this function 'strat' is a single row from the management strategies database - i.e. one strategy  

Overlap is found by applying the '&' operation, which returns true only if both elements are non-zero - i.e. apply the management strategy row-wise to the mammals data, and the sum of the rows equals the total overlap.  

``` {r calc-A}
calculate_A_B <- function(data, strat) {
  
  # subset diet and habitat columns from data
  diets_habs <- data %>%
    select(C_BG:R_hab)
  
  # column number of last diet column
  last_d_col <- ncol(diets_habs) - 4  # 4 habitat columns
  
  # find overlap
  overlap <- t(apply(diets_habs, 1, function(row) row & strat)) # NOTE: THIS ASSUMES THE COLUMNS ALIGN

  # find A (sum diet cols of overlap)
  A <- rowSums(overlap[,1:last_d_col])
  
  # find B (sum habitat cols of overlap)
  B <- rowSums(overlap[,(last_d_col+1):ncol(diets_habs)])
  
  return(data.frame(A, B))
}
```

test code for calculate_A_B():
``` {r test-ab}
test_strat <- man_strats %>% select(!c(C_AQ, M_AQ, H_AQ))
test_strat <- test_strat[1, 2:26] # subset so columns are same as for data
calculate_A_B(mammals, test_strat)
```

### Calculate Dt
Dt = A/(D*F) + B/F  
``` {r calc-Dt}
calculate_Dt <- function(data, strat) {
  A_B <- calculate_A_B(data, strat)
  F_D <- calculate_F_D(data)
  
  calc_Dt <- cbind(A_B, F_D)

  Dt <- calc_Dt$A / (calc_Dt$D * calc_Dt$F) + calc_Dt$B / calc_Dt$F

  return(Dt)
}

```

test calculate_Dt()
``` {r test-dt}
calculate_Dt(mammals, test_strat)

```
## Then calculate Nt
Nt = C1/N + C2/N

### Calculate N  
This uses '|', which is the 'or' function - returns 1 if at least 1 column (above or below ground) is 1 for each nesting habitat.  

``` {r calc-N}
calculate_N <- function(data) {
  N_temp <- data %>%
    select(C_N_AG:R_N_BG) %>%
    mutate(Crop = C_N_AG | C_N_BG,
           Margin = M_N_AG | M_N_BG,
           Hedge = H_N_AG | H_N_BG,
           Riparian = R_N_AG | R_N_BG,
           N = Crop + Margin + Hedge + Riparian)  # calculate N by summing up number of nesting habs
  
  return(N_temp$N)
}

```

### Calculate C1

### Calculate C2


## Finally calculate risk score
when doing this, remember to prep man_strats - ie. same num cols as mammals in same order, and do 1 row at a time - COULD CHANGE SO FUNCTION TAKES IN ALL STRATS AND CALCULATES ROW WISE??
