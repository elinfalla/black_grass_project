---
title: "Farmland Biodiversity Health Index - <br> Mammal Risk Scores"
author: "Elin Falla"
output:
  html_document: default
  pdf_document: default
  word_document: default
fontsize: 11pt
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction  
This script calculates risk scores associated with changes to farm management, for **mammal** species reliant on farmland.  

**Note:** the script needs at least 2 species inputted to run.

The method is from **Butler, S. J. et al.** 'A cross-taxonomic index for quantifying the health of farmland biodiversity.' J. Appl. Ecol. 46, 1154-1162 (2009) https://doi.org/10.1111/j.1365-2664.2009.01709.x  

-----  
 
The **risk score** is calculated as follows:  
$$ Risk = \frac{D_t + N_t}{R}$$
where:  
$D_t$ = the risk score associated with reduced food abundance or availability  
$N_t$ = the risk score associated with reduced breeding success  
$R$ = the species’ reliance on farmland habitat  

-----  

$D_t$ is calculated as follows:    
$$D_t = \frac{A}{D*F} + \frac{B}{F}$$
$D$ = total number of dietary components used by the species  
$F$ = total number of foraging habitat components used by the species  
$A$ = number of points of coincidence between the impact on and species’ use of dietary components  
$B$ = number of points of coincidence between the impact on and species’ use of foraging habitat components  

-----  

$N_t$ is calculated as follows:  
$$N_t = \frac{C1}{N} + \frac{C2}{N}$$
$N$ = number of nesting habitat components used by the species  
$C1$ = number of points of coincidence between potential impact on and the species’ use of nesting habitat components if impact is through reduced success in existing habitat  
$C2$ = number of points of coincidence between potential impact on and the species’ use of nesting habitat components if impact is through loss of habitat  

## Set-up
### Load packages
```{r load-packages, message=FALSE}

rm(list = ls()) # clear env
library(readxl) # for reading in Excel sheets
library(tidyverse) # for data manipulation

```


### Read in required datasets  
Load datasets and replace all NAs with 0s.  
``` {r read-in-data}

# farm management strategies
man_strats <- read_xlsx("change.xlsx", 3) 
man_strats <- man_strats[1:6,]  # just include strategies of interest (Butler strategies)

# mammal matrix data
mammals <- read_xlsx("Mammal matrix.xlsx", skip = 2) 


# replace NAs with 0s in both datasets
man_strats <- man_strats %>% 
  mutate_all(~replace(., is.na(.), 0))

mammals[is.na(mammals)] <- 0
```

## Step 1: Calculate $D_t$ 

### Calculate $F$ and $D$  
$D$ = total number of dietary components used by the species  
$F$ = total number of foraging habitat components used by the species  
``` {r calc-D}
calculate_F_D <- function(data) {
  
  F <- data %>%
    select(C_hab : R_hab) %>%
    rowSums(.)
  
  invertebrates <- data %>%
    select(C_BG : R_vertebrate) %>%
    select(contains(c("AG","BG","AQ"))) %>%
    mutate(num_inverts = rowSums(.) / F,
           inverts_presence = num_inverts | 0) # will be 1 if number of inverts is non-zero
  print(invertebrates)

  non_invertebrates <- data %>%
    select(C_BG : R_vertebrate) %>%  # select all dietary components cols
    select(-contains(c("AG","BG","AQ"))) %>% # unselect invertebrates
    mutate(num_diets = rowSums(.) / F) # sum for each species

  D <- non_invertebrates$num_diets + invertebrates$inverts_presence

  
  # D <- data %>%
  #   select(C_BG : R_AQ) %>%
  #   transmute(D = ceiling(rowSums(.) / F)) # divide each value by value of F for the species to get D. then round up to account for R_AQ

  return(data.frame(F, D))
}
```

``` {r test-D}
calculate_F_D(mammals)
```

### Calculate $A$ and $B$  
$A$ = number of points of coincidence between the impact on and species’ use of dietary components  
$B$ = number of points of coincidence between the impact on and species’ use of foraging habitat components  

In this function 'strat' is a single row from the management strategies database - i.e. one strategy  

Overlap is found by applying the '&' operation, which returns true only if both elements are non-zero - i.e. apply the management strategy row-wise to the mammals data, and the sum of the rows equals the total overlap. This strategy (which is also used to calculate $C1$ and $C2$ later on) assumes that the columns in the two datasets are aligned. There is therefore a check that this is the case, with a warning returned if not.  

``` {r calc-A}
calculate_A_B <- function(data, strat) {
  
  # subset diet and habitat columns from data
  diets_habs <- data %>%
    select(C_BG : R_hab)

  # subset relevant columns from strategy data
  strat <- strat %>%
    select(C_BG : R_hab) %>%
    select(!c(C_AQ, M_AQ, H_AQ)) # remove AQ columns (except R_AQ) so cols align

  # column number of last diet column
  last_d_col <- ncol(diets_habs) - 4  # 4 habitat columns
  
  # Check columns of diets_habs and strat are the same (if not aligned, overlap calculation will not be correct)
  aligned <- identical(colnames(diets_habs), colnames(strat))
  
  if (aligned == F) {
    warning("WARNING: Mammal data and management strategy columns do not align/are not the same - A and B calculations may be incorrect")
  }
  
  # find overlap
  overlap <- data.frame(t(apply(diets_habs, 1, function(row) row & strat))) # NOTE: THIS ASSUMES THE COLUMNS ALIGN
  names(overlap) <- names(diets_habs)
 
  # CALCULATE A (sum diet cols of overlap)
  #A <- rowSums(overlap[,1:last_d_col])
  
  invertebrate_effects <- overlap %>%
    transmute(C = C_BG | C_AG,
           M = M_BG | M_AG,
           H = H_BG | H_AG,
           R = R_BG | R_AG)

  hab_names <- c("C", "M", "H", "R")
  
  for (hab in hab_names) {
    
    inverts <- overlap %>%
      select(contains(hab) & contains(c("AG", "BG")))
    
    overlap_hab <- overlap[,names(inverts)]
    overlap_hab_sums <- rowSums(overlap_hab)
    
    for (species in 1:nrow(data)) { # for each species

      if (overlap_hab_sums[species] > 1) { # if more than one invertebrate type (above/below ground) affected

        BG_col <- names(overlap_hab)[1]
  
        overlap[species,BG_col] <- 0 # arbitrarily set one (below-ground) to 0 - same as combining the columns
      }
    }
  }
  A <- rowSums(overlap[,1:last_d_col])
  
  # CALCULATE B (sum habitat cols of overlap)
  B <- rowSums(overlap[,(last_d_col+1):ncol(diets_habs)])
  
  return(data.frame(A, B))
}

```

``` {r}
calculate_A_B(mammals, man_strats[4,])
```



### Calculate $D_t$  

$$D_t = \frac{A}{D*F} + \frac{B}{F}$$
``` {r calc-Dt}
calculate_Dt <- function(data, strat) {
  
  A_B <- calculate_A_B(data, strat)
  A <- A_B$A
  B <- A_B$B
  
  F_D <- calculate_F_D(data)
  F <- F_D$F
  D <- F_D$D

  Dt <- A/(D * F) + B/F
  
  # replace infinite or NA values with 0
  Dt <- 
  ifelse(
    is.nan(Dt) | is.infinite(Dt) == T,  # test
    0, # if yes
    Dt  # if no
  )
  return(Dt)
}

```

``` {r}
calculate_Dt(mammals, man_strats[2,])
```

## Step 2: Calculate $N_t$

### Calculate $N$ 
$N$ = number of nesting habitat components used by the species 

This uses '|', which is the 'or' operator - returns 1 if at least 1 column (above or below ground) is 1 for each nesting habitat.  

``` {r calc-N}
calculate_N <- function(data) {
  N_temp <- data %>%
    select(C_N_AG : R_N_BG) %>%
    mutate(Crop = C_N_AG | C_N_BG,
           Margin = M_N_AG | M_N_BG,
           Hedge = H_N_AG | H_N_BG,
           Riparian = R_N_AG | R_N_BG,
           N = Crop + Margin + Hedge + Riparian)  # calculate N by summing up number of nesting habs
  
  return(N_temp$N)
}

```

``` {r test-n}
data.frame(calculate_N(mammals))

```

### Calculate $C1$ and $C2$ 
$C1$ = number of points of coincidence between potential impact on and the species’ use of nesting habitat components if impact is through reduced success in existing habitat  

$C2$ = number of points of coincidence between potential impact on and the species’ use of nesting habitat components if impact is through loss of habitat  

Like for calculating $A$ and $B$ above, overlaps are calculated using the '&' operator - returns 1 if both values (i.e. the mammal nesting requirement and whether its affected by the management strategy) are non-zero.  

``` {r calc-C1C2}
calculate_C1_C2 <- function(data, strat) {
  
  nesting <- data %>%
    select(C_N_AG : R_N_BG)  # select nesting columns of mammal data
 
  nest_effects <- strat %>%
    select(C_N_AG : R_N_BG_S)  # select nesting columns of strategy data
  
  # CALCULATE C1 - effects of reduced nesting success
  nest_success <- nest_effects %>%
    select(contains("_S"))  # select nesting success columns
      
  # Check columns of nest_success and nesting are the same (if not aligned, overlap calculation will not be correct)
  to_compare <- gsub(pattern = "_S", replacement = "", colnames(nest_success))  # remove "_S" from nesting_success colnames to compare
  aligned <- identical(to_compare, colnames(nesting))
  
  if (aligned == F) {
    warning("WARNING: Mammal data and management strategy columns do not align/are not the same - C1 calculations will be incorrect")
  }
  
  # Calculate overlap
  C1_overlap <- t(apply(nesting, 1, function(row) row & nest_success))  
  C1 <- rowSums(C1_overlap)  # sum overlaps to get C1
  
  
  # CALCULATE C2 - effects of loss of nesting habitat
  nest_habs <- nest_effects %>%
    select(!contains("_S"))  # select habitat loss columns
   
  # Check columns of nest_habs and nesting are the same (if not aligned, overlap calculation will not be correct)
  aligned <- identical(colnames(nest_habs), colnames(nesting))
  
  if (aligned == F) {
    warning("WARNING: Mammal data and management strategy columns do not align/are not the same - C2 calculations will be incorrect")
  }
  
  # Calculate overlap
  C2_overlap <- t(apply(nesting, 1, function(row) row & nest_habs))  
  C2 <- rowSums(C2_overlap)  # sum overlaps to get C2
  
  return(data.frame(C1, C2))
}

```

### Calculate $N_t$
$$N_t = \frac{C1}{N} + \frac{C2}{N}$$

``` {r calc-Nt}
calculate_Nt <- function(data, strat) {
  
  N <- calculate_N(data)
  
  C1_C2 <- calculate_C1_C2(data, strat)
  C1 <- C1_C2$C1
  C2 <- C1_C2$C2

  Nt <- (C1/N) + (C2/N)
  
  # replace infinite or NA values with 0
  Nt <- 
    ifelse(
      is.nan(Nt) | is.infinite(Nt) == T,  # test
      0, # if yes
      Nt  # if no
    ) 
  
  return(Nt)
}

```

## Step 3: Calculate risk score
This function can take multiple strategies and outputs risk scores for each species for each strategy. It also (in the case that multiple strategies are inputted) calculates a **total risk score**, by summing the risk scores across all management strategies for each species.  
$$ Risk = \frac{D_t + N_t}{R}$$
``` {r calc-riskscore}
calculate_riskscores <- function(data, strategies) {
  
  # initialise riskscores dataframe, rows are species, cols are strategies
  riskscores <- data.frame(matrix(NA, 
                                  nrow = nrow(data), 
                                  ncol = nrow(strategies) + 1)) # +1 to add in species names as first col
  # put species names in first col
  riskscores[,1] <- data[,1]
  
  # name columns of riskscores according to strategies
  strat_names <- strategies %>% pull(agric_change)
  colnames(riskscores) <- c("species", strat_names)
  
  # extract reliance (R) values from mammal data
  R <- data[,"Reliance"]  
  
  # CALCULATE RISK SCORES per strategy and store in riskscores dataframe
  for (strat in 1:nrow(strategies)) {
    
    Dt <- calculate_Dt(data, strategies[strat,])
    Nt <- calculate_Nt(data, strategies[strat,])
    
    riskscores[,strat+1] <- (Dt + Nt) / R
  }
  
  # calculate total risk for each species by summing risk across all strategies (if more than one strategy)
  if (nrow(strategies) > 1) {
    riskscores$total_risk <- rowSums(riskscores[,-1])
  }
  
  return(riskscores)
}
```

### Test risk scores are correct
Calculate risk scores for the strategies used in Butler's paper in order to check they are the same.  
``` {r test-risk}
# Calculate risk scores
riskscores <- calculate_riskscores(mammals, man_strats)

# Display risk scores
riskscores


butler_sp <- c(
"Yellow-necked mouse","Wood mouse","Water vole","Barbastelle","Roe deer","Red deer","Sika","Bank vole","Fallow deer","Serotine","Hedgehog","Chinese water deer","Brown hare","Otter","Badger","Harvest mouse","Field vole","Muntjac","House mouse","Common doormouse","Stoat","Weasel","Polecat","Bechsteins","Brandts","Daubentons","Whiskered","Natterers","Water shrew","Leisler","Noctule","Rabbit","Nathusius pipistrelle","Pipistrelle","Soprano pipistrelle","Brown long-eared","Grey long-eared bat","Brown rat","Greater horseshoe","Lesser horseshoe","Common shrew","Pygmy shrew","Common mole","Red fox"
)
butler_risk <- c(0.78,1.79,1.75,1.75,1.17,0.44,0.33,1.33,0.67,3.50,1.50,1.50,3.33,2.00,1.50,3.63,1.42,0.78,2.04,0.78,1.50,1.38,1.86,1.75,1.75,1.75,1.75,1.75,1.20,1.75,3.50,1.17,1.17,3.50,1.75,1.75,1.75,1.81,2.50,2.50,2.00,2.00,1.75,1.50
)
butler <- data.frame(butler_sp, butler_risk)
butler <- butler[order(butler$butler_sp),]
butler$my_risk <- round(riskscores$total_risk, 2)
butler$same <- butler$my_risk == butler$butler_risk
butler$diff <- butler$my_risk - butler$butler_risk
riskscores
butler

butler$old_diff <- round(riskscores$total_risk - butler$butler_risk,2)

```

