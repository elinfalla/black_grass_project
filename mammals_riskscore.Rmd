---
title: "Farmland Biodiversity Health Index - <br> Mammal Risk Scores"
author: "Elin Falla"
output:
  html_document: default
  pdf_document: default
  word_document: default
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set-up
```{r load-packages, message=FALSE}

rm(list = ls()) # clear env
library(readxl) # for reading in Excel sheets
library(tidyverse) # for data manipulation

```


## Read in required datasets  
``` {r read-in-data}

# farm management strategies
man_strats <- read_xlsx("change.xlsx", 3) 
man_strats <- man_strats[1:6,]  # just include strategies of interest (Butler strategies)

# mammal matrix data
mammals <- read_xlsx("Mammal matrix.xlsx", skip = 2) 

```

## Replace NAs with 0s in both datasets
``` {r replace-na}
man_strats <- man_strats %>% 
  mutate_all(~replace(., is.na(.), 0))

mammals[is.na(mammals)] <- 0
```

The risk score is calculated as follows: 
Risk score = (Dt + Nt) / R  
where:  
Dt = A/(D*F) + B/F  
Nt = C1/N + C2/N  

## First calculate Dt  

### Calculate F and D  
D = total number of dietary components used by the species  
F = total number of foraging habitat components used by the species  
``` {r calc-D}
calculate_F_D <- function(data) {
  
  F <- data %>%
    select(C_hab : R_hab) %>%
    rowSums(.)
  
  D_temp <- data %>% 
    select(C_BG : R_vertebrate) %>%  # select all dietary components cols
    rowSums(.) # sum for each species
  
  D <- ceiling(D_temp / F)  # divide each value by value of F for the species to get D. then round up to account for R_AQ
  
  return(data.frame(F,D))
}
```

### Calculate A and B  
A = number of points of coincidence between the impact on and species’ use of dietary components  
B = number of points of coincidence between the impact on and species’ use of foraging habitat components 

Remember, in this function 'strat' is a single row from the management strategies database - i.e. one strategy  

Overlap is found by applying the '&' operation, which returns true only if both elements are non-zero - i.e. apply the management strategy row-wise to the mammals data, and the sum of the rows equals the total overlap.  

``` {r calc-A}
calculate_A_B <- function(data, strat) {
  
  # subset diet and habitat columns from data
  diets_habs <- data %>%
    select(C_BG : R_hab)
  
  # subset relevant columns from strategy data
  strat <- strat %>%
    select(C_BG : R_hab) %>%
    select(!c(C_AQ, M_AQ, H_AQ)) # remove AQ columns (except R_AQ) so cols align
  
  # column number of last diet column
  last_d_col <- ncol(diets_habs) - 4  # 4 habitat columns
  
  # Check columns of diets_habs and strat are the same (if not aligned, overlap calculation will not be correct)
  aligned <- identical(colnames(diets_habs), colnames(strat))
  
  if (aligned == F) {
    warning("WARNING: Mammal data and management strategy columns do not align/are not the same - A and B calculations will be incorrect")
  }
  
  # find overlap
  overlap <- t(apply(diets_habs, 1, function(row) row & strat)) # NOTE: THIS ASSUMES THE COLUMNS ALIGN
  
  # CALCULATE A (sum diet cols of overlap)
  A <- rowSums(overlap[,1:last_d_col])
  
  # CALCULATE B (sum habitat cols of overlap)
  B <- rowSums(overlap[,(last_d_col+1):ncol(diets_habs)])
  
  return(data.frame(A, B))
}

```

test code for calculate_A_B():
``` {r test-ab, results="hide"}
test_strat <- man_strats[1,]
calculate_A_B(mammals, test_strat)

```

### Calculate Dt
Dt = A/(D*F) + B/F  
``` {r calc-Dt}
calculate_Dt <- function(data, strat) {
  
  A_B <- calculate_A_B(data, strat)
  A <- A_B$A
  B <- A_B$B
  
  F_D <- calculate_F_D(data)
  F <- F_D$F
  D <- F_D$D

  Dt <- A/(D * F) + B/F
  
  # replace infinite or NA values with 0
  Dt <- 
  ifelse(
    is.nan(Dt) | is.infinite(Dt) == T,  # test
    0, # if yes
    Dt  # if no
  )
  return(Dt)
}

```

test calculate_Dt()
``` {r test-dt, results="hide"}
calculate_Dt(mammals, test_strat)

```
## Then calculate Nt
Nt = C1/N + C2/N

### Calculate N  
This uses '|', which is the 'or' operator - returns 1 if at least 1 column (above or below ground) is 1 for each nesting habitat.  

N = number of nesting habitat components used by the species  

``` {r calc-N}
calculate_N <- function(data) {
  N_temp <- data %>%
    select(C_N_AG : R_N_BG) %>%
    mutate(Crop = C_N_AG | C_N_BG,
           Margin = M_N_AG | M_N_BG,
           Hedge = H_N_AG | H_N_BG,
           Riparian = R_N_AG | R_N_BG,
           N = Crop + Margin + Hedge + Riparian)  # calculate N by summing up number of nesting habs
  
  return(N_temp$N)
}

```


### Calculate C1 and C2  
Like for calculating A and B above, overlaps are calculated using the '&' operator - returns 1 if both values (i.e. the mammal nesting requirement and whether its affected by the management strategy) are non-zero.  

C1 = number of points of coincidence between potential impact on and the species’ use of nesting habitat components if impact is through reduced success in existing habitat  

C2 = number of points of coincidence between potential impact on and the species’ use of nesting habitat components if impact is through loss of habitat  

``` {r calc-C1C2}
calculate_C1_C2 <- function(data, strat) {
  
  nesting <- data %>%
    select(C_N_AG : R_N_BG)  # select nesting columns of mammal data
 
  nest_effects <- strat %>%
    select(C_N_AG : R_N_BG_S)  # select nesting columns of strategy data
  
  # CALCULATE C1 - effects of reduced nesting success
  nest_success <- nest_effects %>%
    select(contains("_S"))  # select nesting success columns
      
  # Check columns of nest_success and nesting are the same (if not aligned, overlap calculation will not be correct)
  to_compare <- gsub(pattern = "_S", replacement = "", colnames(nest_success))  # remove "_S" from nesting_success colnames to compare
  aligned <- identical(to_compare, colnames(nesting))
  
  if (aligned == F) {
    warning("WARNING: Mammal data and management strategy columns do not align/are not the same - C1 calculations will be incorrect")
  }
  
  # Calculate overlap
  C1_overlap <- t(apply(nesting, 1, function(row) row & nest_success))  
  C1 <- rowSums(C1_overlap)  # sum overlaps to get C1
  
  
  # CALCULATE C2 - effects of loss of nesting habitat
  nest_habs <- nest_effects %>%
    select(!contains("_S"))  # select habitat loss columns
   
  # Check columns of nest_habs and nesting are the same (if not aligned, overlap calculation will not be correct)
  aligned <- identical(colnames(nest_habs), colnames(nesting))
  
  if (aligned == F) {
    warning("WARNING: Mammal data and management strategy columns do not align/are not the same - C2 calculations will be incorrect")
  }
  
  # Calculate overlap
  C2_overlap <- t(apply(nesting, 1, function(row) row & nest_habs))  
  C2 <- rowSums(C2_overlap)  # sum overlaps to get C2
  
  return(data.frame(C1, C2))
}

```

test calculate_C1_C2():
``` {r test-C1C2, results="hide"}
nest_test_strat <- man_strats[5,]
nest_test_strat["H_N_AG_S"] <- -1
nest_test_strat["M_N_BG"] <- -1
calculate_C1_C2(mammals, nest_test_strat)
```


### Calculate Nt
Nt = C1/N + C2/N
``` {r calc-Nt}
calculate_Nt <- function(data, strat) {
  
  N <- calculate_N(data)
  
  C1_C2 <- calculate_C1_C2(data, strat)
  C1 <- C1_C2$C1
  C2 <- C1_C2$C2

  Nt <- (C1/N) + (C2/N)
  
  # replace infinite or NA values with 0
  Nt <- 
    ifelse(
      is.nan(Nt) | is.infinite(Nt) == T,  # test
      0, # if yes
      Nt  # if no
    ) 
  
  return(Nt)
}

```

test calculate_Nt():  
``` {r test-Nt, results="hide"}
calculate_Nt(mammals, nest_test_strat)
```


## Finally calculate risk score
This function can take multiple strategies and outputs risk scores for each species for each strategy
risk <- (Dt + Nt) / R
``` {r calc-riskscore}
calculate_riskscores <- function(data, strategies) {
  
  # initialise riskscores dataframe, rows are species, cols are strategies
  riskscores <- data.frame(matrix(NA, 
                                  nrow = nrow(data), 
                                  ncol = nrow(strategies) + 1)) # +1 to add in species names as first col
  # put species names in first col
  riskscores[,1] <- data[,1]
  
  # name columns of riskscores according to strategies
  strat_names <- strategies %>% pull(agric_change)
  colnames(riskscores) <- c("species", strat_names)
  
  # extract reliance (R) values from mammal data
  R <- data[,"Reliance"]  
  
  # CALCULATE RISK SCORES per strategy and store in riskscores dataframe
  for (strat in 1:nrow(strategies)) {
    
    Dt <- calculate_Dt(data, strategies[strat,])
    Nt <- calculate_Nt(data, strategies[strat,])
    
    riskscores[,strat+1] <- (Dt + Nt) / R
  }
  
  # calculate total risk for each species by summing risk across all strategies
  riskscores$total_risk <- rowSums(riskscores[,-1])
  
  return(riskscores)
}
```

### Test riskscores are correct
Calculate risk scores for the strategies used in Butler's paper and check they are the same.  
``` {r test-risk}
# Calculate risk scores
riskscores <- calculate_riskscores(mammals, man_strats)

# Display risk scores
riskscores

```

