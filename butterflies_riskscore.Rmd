---
title: "Farmland Biodiversity Health Index - <br> Mammal Risk Scores"
author: "Elin Falla"
output:
  html_document: default
  pdf_document: default
  word_document: default
fontsize: 11pt
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction  
This script calculates risk scores associated with changes to farm management, for **butterfly** species reliant on farmland.  

**Note:** the script needs at least 2 species inputted to run.

The method is from **Butler, S. J. et al.** 'A cross-taxonomic index for quantifying the health of farmland biodiversity.' J. Appl. Ecol. 46, 1154-1162 (2009) https://doi.org/10.1111/j.1365-2664.2009.01709.x  

-----

The risk score is calculated as follows:  
$$ Risk = \frac{P_{ta} + F_{ta}}{R_a} + \frac{P_{tl} + F_{tl}}{R_l}$$

where subscript "l" refers to larvae and subscript "a" refers to adults. The risk score is hence the sum of the risk scores for the adult and larval stage for a particular species, where:  
$P_t$ = the risk score associated with reduced foraging activity potential 
$F_t$ = the risk score associated with reduction in forage plant availability
$R$ = the species’ reliance on farmland habitat  

$P_t$ is calculated as follows:  
$$P_t = \frac{G_t}{G*H}$$

$G_t$ = total number of generations of the species' given life stage (i.e. $G_{ta}$ for adults, $G_{tl}$ for larvae) active in the activity periods affected
$G$ = number of generations of the life stage across all activity periods (i.e. per year)
$H$ = number of habitat components used by the species' life stage  

-----  

$F_t$ is calculated as follows:  
$$N_t = \frac{A}{F}$$
$A$ = number of points of coincidence between impact on and species life stage's use of forage plant families  
$F$ = number of points of coincidence between species life stage's habitat use and the location of its forage plants  

## Set-up
### Load packages
```{r load-packages, message=FALSE}

rm(list = ls()) # clear env
library(readxl) # for reading in Excel sheets
library(tidyverse) # for data manipulation

```

### Read in required datasets  
Load datasets and replace all NAs with 0s.  
``` {r read-in-data}

# farm management strategies
man_strats <- read_xlsx("change.xlsx", 5) 

# butterfly requirements matrix data
butterfly <- read_xlsx("Butterfly_requirements.xlsx", skip = 3) 

# forage plant locations
plant_locs <- read_xlsx("forage_plant_location.xlsx", na="NA")

# butterfly forage plants
butterfly_plants <- read_xlsx("butterfly_forage_plants.xlsx")

# replace NAs with 0s in all datasets
man_strats <- man_strats %>% 
  mutate_all(~replace(., is.na(.), 0))

butterfly <- butterfly %>% 
  mutate_all(~replace(., is.na(.), 0))

plant_locs <- plant_locs %>% 
  mutate_all(~replace(., is.na(.), 0))

butterfly_plants <- butterfly_plants %>%
  mutate_all(~replace(., is.na(.), 0))
```

### Write function to create separate adult and larval datasets
``` {r sep-a-l}
separate_lifestages <- function(data) {
  
  ## Function to create separate datasets for adults and larvae
  
  if ("Lifestage" %in% colnames(data)) {  # this is the case for the butterfly forage plants matrix
    adults <- data[data$Lifestage == "a",]
    larvae <- data[data$Lifestage == "l",]
  }
  else {  # for the butterfly requirements matrix
    adults <- data %>%
    select(contains("Ad_"))
    
    # rename cols to   not include "Ad_"
    colnames(adults) <- gsub(pattern = "Ad_", replacement = "", colnames(adults)) 

    larvae <- data %>%
    select(contains("L_"))
    
    # rename cols to not include "L_"
    colnames(larvae) <- gsub(pattern = "L_", replacement = "", colnames(larvae))  
  }
  
  return(list(adults, larvae))
}
```
## Calculate $P_t$ (for adults, $P_{ta}$, and larvae, $P_{tl}$)

### Calculate $G$ and $H$
$G$ = number of generations across all activity periods (ie. number of generations per year)
$H$ = number of habitat components used by the species 


``` {r calc-Ga-Gl}
calculate_G_H <- function(data) {

  # create output dataframe
  output <- data.frame(H = rep(NA, nrow(data)),
                       G = rep(NA, nrow(data)))

  # calculate H
  output[,"H"] <- data %>%
    select(hab_start : hab_end) %>%  # select habitat columns
    select(-c(hab_start, hab_end)) %>%  # remove marker cols
    mutate(Cropped = CA_hab | CG_hab) %>%  # create cropped area col and remove CG and CA
    select(-c(CA_hab, CG_hab)) %>%
    rowSums(.)
  
  # calculate G (select generations col of respective df)
  output[,"G"] <- data %>%
    select(gens_start : gens_end) %>%
    rowSums(.)

  return(output)
}
```

test G + H func:
``` {r test-GH}
adult_data <- separate_lifestages(butterfly)[[1]]
res <- calculate_G_H(adult_data)
#res$species <- all_species
res
```

### Calculate $G_t$
$G_t$ = number of generations of a species active in the activity periods affected

Here, 'strat' is a single management strategy - i.e. one row of the management strategy data frame.

number of each gens foraging habitats affected


``` {r calc-Gta-Gtl}
calculate_Gt <- function(data, strat) {

  # select relevant cols of strat
  activity_effects <- strat %>%
    select(activity_start : activity_end) %>%
    select(-c(activity_start, activity_end)) # remove start and end cols
  
  activity <- data %>%
    select(activity_start : activity_end) %>%
    select(-c(activity_start, activity_end))

  gens_per_period <- data %>%
    select(gens_start : gens_end) %>%
    select(-c(gens_start, gens_end))
  
  early <- gens_per_period %>%
    select(contains("early")) %>%
    rowSums(.)
  mid <- gens_per_period %>%
    select(contains("mid")) %>%
    rowSums(.)
  late <- gens_per_period %>%
    select(contains("late")) %>%
    rowSums(.)

  all_gens_per_period <- data.frame(rep(data.frame(early, mid, late), 4))

  # Check columns of diets_habs and strat are the same (if not aligned, overlap calculation will not be correct)
  aligned <- identical(colnames(activity), colnames(activity_effects))
  
  if (aligned == F) {
    warning(paste0("WARNING: Butterfly data and management strategy columns do not align/are not the same - Gt calculations will be incorrect. Lifestage = ", i, ", 1=adult, 2=larvae"))
  }
  
  # find overlap
  overlap <- as.data.frame(t(apply(activity, 1, function(row) row & activity_effects))) # NOTE: THIS ASSUMES THE COLUMNS ALIGN
  names(overlap) <- names(activity_effects)

  Cropped <- t(apply(overlap, 1, function(row) row[7:9] | row[10:12] ))
  
  truncated_overlap <- as_tibble(overlap) %>%
    select(-contains(c("CA","CG"))) %>%
    cbind(., Cropped)

  all_gens_affected <- truncated_overlap * all_gens_per_period

  Gt <- rowSums(all_gens_affected)
 
  return(Gt)
  
}
```

test calc Gt:
``` {r test-Gt}

out <- calculate_Gt(adult_data, man_strats[3,])
#out$species <- all_species
out
# out$Gta == calculate_Ga_Gl_Ha_Hl(butterfly)$Ga | out$Gta == 0
# out$Gtl == calculate_Ga_Gl_Ha_Hl(butterfly)$Gl | out$Gtl == 0

```

### Calculate Pt
Pta = Gta/(Ga*Ha)
Ptl = Gtl/(Gl*Hl)

``` {r calc-Pt}
calculate_Pt <- function(data, strat) {
  
  G_H <- calculate_G_H(data)
  G <- G_H$G
  H <- G_H$H

  Gt <- calculate_Gt(data, strat)
  
  # CALCULATE Pt
  Pt = Gt / (G * H)
  
  # replace infinite or NA values with 0
  Pt <- 
  ifelse(
    is.nan(Pt) | is.infinite(Pt) == T,  # test
    0, # if yes
    Pt  # if no
  )
  
  return(Pt)
}
```


## Calculate $F_t$ (for $a$ and $l$)

### Calculate $F$ and $A$
$F$ = points of coincidence between species habitat use and the location of its forage plants 
$A$ = number of points of coincidence between the impact on and species’ use of forage plant families

Butterflies have long tongues, so adults can forage on any plant in the habitat(s) they occupy. Therefore, Fa (F for adults) will just be the total number of forage plants found in the foraging habitat(s) of each butterfly species.

Larvae have much more specific plant forage families.


``` {r calc-Al-Aa-Fa-Fl}
calculate_A_F <- function(data, plants, plant_locs, strat) {
  
  # PUT IN CHECK THAT COLUMNS ALIGN

  # select hab + damp cols of change data
  hab_effects <- strat %>%
    select(hab_start:hab_end, damp_start:damp_end)

  # pull plant names from plant_locs and plants, to check they are the same
  plant_locs_names <- plant_locs %>% pull(plantfamily)
  plants_names <- colnames(plants %>% 
                             select(species_start:species_end) %>% 
                             select(-c(species_start, species_end)))
  
  # check plant names are the same, print warning if not
  if (identical(plant_locs_names, plants_names) == F) {
    warning("WARNING: columns of butterfly forage plants are not the same as rows of plant locations data, i.e. plant species are not the same. Calculations may be incorrect.")
    
    print("Cols of butterfly plant data:")
    print(paste(plants_names))
    print(paste("Rows of plant locations data:", plant_locs_names))
  }
  
  # initialise output dataframe
  output <- data.frame(F = rep(NA, nrow(data)),
                       A = rep(NA, nrow(data)))

  # subset appropriate butterfly requirements data to habitat and damp cols
  habs <-  data %>% 
    select(hab_start:hab_end, damp_start:damp_end)
  
  # select plant species cols from butterfly forage plants data
  butterfly_plants <- plants %>% 
  select(species_start : species_end) %>%
  select(-c(species_start, species_end)) # remove marker cols
  
  # find overlap between species habitat use and effects on habitat
  overlap <- as.data.frame(t(apply(habs, 1, function(row) row & hab_effects)))
  colnames(overlap) <- colnames(habs)

  # split effects on species into general and damp effects
  general_effects <- overlap %>% 
    select(hab_start : hab_end) %>%
    select(-c(hab_start, hab_end))  # remove marker cols
  
  damp_effects <- overlap %>% 
    select(damp_start : damp_end) %>%
    select(-c(damp_start, damp_end))  # remove marker cols
  
  # calculate A and F for each species
  for(species in 1:nrow(habs)) {

    sp_general_effects <- general_effects[species,]
    sp_damp_effects <- damp_effects[species,]

    # remove species name col of plant locs (so columns align with habs)
    no_name_plant_locs <- plant_locs[,-1] 
   
    # subset plant locs to only include plants the species forages on
    sp_plant_locs <- no_name_plant_locs[which(butterfly_plants[species,] == 1),]
  
    # if species has no forage plants, print warning and set A and F to 0
    if (nrow(sp_plant_locs) == 0) { 
      warning(paste("WARNING: Species", species, "has 0 forage plants. Al = 0
                    "))
      output[species, lifestage] <- 0
      output[species, lifestage+2] <- 0
      next  # go to next iteration of for loop
    }

    # CALCULATE F
    
    # subset habitat to current species
    sp_habs <- habs %>%
      select(hab_start : hab_end) %>%
      select(-c(hab_start, hab_end))
    sp_habs <- sp_habs[species,]
    
    # remove 'cropped area' habitat (col) so the sp_plant_loc cols align with sp_habs (species habitat)
    no_crops_plant_locs <- sp_plant_locs %>%
      select(-croppedarea)
    
    # subset sp_plant_locs to only habitats occupied by the species
    all_forage_plants <- no_crops_plant_locs[,which(sp_habs != 0)]
    
    # if both grass and arable fields are selected (are part of species habitat), then remove them and replace with 'croppedarea' col
    if (has_name(all_forage_plants, "grassfields") && has_name(all_forage_plants, "arablefields")) {
      all_forage_plants <- all_forage_plants %>%
        select(-c(grassfields, arablefields)) %>%
        cbind(., sp_plant_locs$croppedarea)
    }
    output[species, "F"] <- sum(all_forage_plants)

    # CALCULATE A
    
    # find all plants affected by general and damp hab effects
    sp_effects <- list(sp_general_effects, sp_damp_effects)
    plants_affected <- c(NA, NA)
    
    for (effect in 1:length(sp_effects)) {

      plant_locs_affected <- sp_plant_locs[,which(sp_effects[[effect]] != 0)]

      if (ncol(plant_locs_affected) == 0) {

        plants_affected[effect] <- 0
        next  # if no plants affected, skip to next iteration (next effect)
      }
      
      # if both grass and arable fields are affected, then remove them and replace with 'croppedarea' col
      if (has_name(plant_locs_affected, "grassfields") && has_name(plant_locs_affected, "arablefields")) {
        plant_locs_affected <- plant_locs_affected %>%
          select(-c(grassfields, arablefields)) %>%
          cbind(., sp_plant_locs$croppedarea)
      } 
      else if (hab_effects$CG_hab != 0 & hab_effects$CA_hab != 0 & effect == 1){ #  if strat affects all crops (not damp)
        if (sum(has_name(plant_locs_affected, c("grassfields", "arablefields"))) > 0) { # if sp is on at least 1 crop
          
          if (sum(sp_habs) > 1) { # if sp is also on at least 1 other hab
           
            plant_locs_affected <- plant_locs_affected %>% # do same as above - used cropped area col
            select(-contains(c("grassfields", "arablefields"))) %>%
            cbind(., sp_plant_locs$croppedarea)  ## IS THIS TRUE FOR DAMP PLANTS TOO??
          }
        }
      }

      if (effect == 2) {  # if damp effects, need to subset to only damp plants
        damp_plants_affected <- plant_locs_affected[sp_plant_locs$likesdamp == "yes",]

        plants_affected[effect] <- sum(damp_plants_affected)
      }
      else {
        plants_affected[effect] <- sum(plant_locs_affected)
      }
      
    }
    # sum plants affected by general and damp effects to get total effects
    total_plants_affected <- sum(plants_affected)
  
    output[species, "A"] <- total_plants_affected
  }

  return(output)
}
```

``` {r test-Fa}
adult_data <- separate_lifestages(butterfly)[[1]]
larval_data <- separate_lifestages(butterfly)[[2]]
adult_plants <- separate_lifestages(butterfly_plants)[[1]]
larval_plants <- separate_lifestages(butterfly_plants)[[2]]

res <- calculate_A_F(adult_data, adult_plants, plant_locs, man_strats[2, ])
#res$species <- all_species
res
all_species <- c("Brimstone","Brown hairstreak","Comma","Common blue","Essex skipper","Gatekeeper","Green-veined white","Holly blue","Large skipper","Large white","Marbled white",
"Marsh fritillary",
"Meadow brown ",
"Orange tip",
"Peacock",
"Ringlet",
"Small copper",
"Small heath",
"Small skipper",
"Small tortoiseshell",
"Small white",
"Speckled wood",
"Wall",
"White-letter hairstreak")

# 
# butler_Fa <- c(73, 27, 73, 59, 29, 41, 73, 59, 29, 73, 56, 15, 59, 73, 73, 70, 56, 29, 29, 73, 73, 41, 15, 55)
# all.equal(res$Fa, butler_Fa)
# which(res$Fa != butler_Fa) 
# 
# 
# butler_Fl <- c(1, 1, 6, 2, 2, 1, 2, 6, 2, 2, 2, 1, 2, 3, 2, 3, 2, 2, 2, 2, 3, 1, 1, 1)
# all.equal(res$Fl, butler_Fl)
# which(res$Fl != butler_Fl) 

```

### Calculate $F_t$
 
``` {r calc-Ft}
calculate_Ft <- function(data, plants, plant_locs, strat) {

  A_F <- calculate_A_F(data, plants, plant_locs, strat)
  A <- A_F$A
  F <- A_F$F

  # CALCULATE Ft
  Ft <- A / F

  # replace infinite or NA values with 0
  Ft <- 
  ifelse(
    is.nan(Ft) | is.infinite(Ft) == T,  # test
    0, # if yes
    Ft  # if no
  )
  
  return(Ft)
}
```

``` {r test-Ft}
# sum <- 0
# vals <- 0
# for (i in 1:6) {
#   Ft <- calculate_Fta_Ftl(butterfly, butterfly_plants, plant_locs, man_strats[i,])
#   Pt <- calculate_Pta_Ptl(butterfly, man_strats[i,])
#   sum <- sum + Ft + Pt
#   vals <- cbind(vals, Pt$Ptl + Ft$Ftl)
# }
# 
# sum$species <- all_species
# sum
# vals
```

## Calculate risk score
``` {r calc-riskscore}
calc_butterfly_riskscore <- function(data, plants, plant_locs, strategies) {
  
  # initialise riskscores dataframe, rows are species, cols are strategies
  riskscores <- data.frame(matrix(NA, 
                                  nrow = nrow(data), 
                                  ncol = nrow(strategies) + 1)) # +1 to add in species names
  # put species names in first col
  riskscores[,1] <- data[,1]
  
  # name columns of riskscores according to strategies
  strat_names <- strategies %>% pull(agric_change)
  colnames(riskscores) <- c("species", strat_names)
  
  # extract reliance (R) values for adults and larvae from butterfly data
  R <- data %>% 
    select(contains("reliance"))
  Ra <- R %>%
    select(contains("Ad_"))
  Rl <- R %>%
    select(contains("L_"))
  
  # CALCULATE RISK SCORES per strategy and store in riskscores dataframe
  for (strat in 1:nrow(strategies)) {
    
    # separate adults and larval stages for both butterfly and plants data
    butterfly_data <- separate_lifestages(data)
    adult_data <- butterfly_data[[1]]
    larval_data <- butterfly_data[[2]]
    
    plants_data <- separate_lifestages(plants)
    adult_plants <- plants_data[[1]]
    larval_plants <- plants_data[[2]]
    
    # CALCULATE PT AND FT for both adults and larvae
    Pta <- calculate_Pt(adult_data, strategies[strat,])
    Ptl <- calculate_Pt(larval_data, strategies[strat,])
    
    Fta <- calculate_Ft(adult_data, adult_plants, plant_locs, strategies[strat,])
    Ftl <- calculate_Ft(larval_data, larval_plants, plant_locs, strategies[strat,])
    
    # CALCULATE RISK SCORE
    riskscores[,strat+1] <- ((Pta + Fta) / Ra) + ((Ptl + Ftl) / Rl)
  }
  
  # calculate total risk for each species by summing risk across all strategies (if more than one strategy)
  if (nrow(strategies) > 1) {
    riskscores$total_risk <- rowSums(riskscores[,-1])
  }
  
  return(riskscores)
}
  
```

### Test risk score
Test scores against Butler's risk scores to ensure method is correct.
``` {r test-riskscore}
risk <- calc_butterfly_riskscore(butterfly, butterfly_plants, plant_locs, man_strats)
risk
# 
# risk$species_latin <- c("Gonepteryx_rhamni", "Thecla_betulae", "Polygonum_c_album", "Polyommatus_icarus", "Thymelicus_lineola", 
#                         "Pyronia_tithonus", "Pieris_napi", "Celastrina_argiolus", "Ochlodes_sylvanus", "Pieris_brassicae",
#                         "Melanargia_galathea", "Euphydryas_aurina", "Maniola_jurtina", "Anthocharis_cardamines", "Aglais_io", 
#                         "Aphantopus_hyperantus", "Lycaena_phlaeas", "Coenonympha_pamphilus", "Thymelicus_sylvestris", "Aglais_urticae",
#                         "Pieris_rapae", "Pararge_aegeria", "Lasiommata_megera", "Satyrium_w_album")
# 
# risk_sorted <- risk[order(risk$species_latin),]
butler_risk <- c(2.19, 1.65, 3.81, 2.01, 1.42, 1.44, 2.10, 3.53, 1.67, 2.18, 3.03, 1.85, 2.02, 1.85, 2.10, 1.56, 2.34, 1.86, 1.65, 1.06, 2.42, 2.15, 2.10, 2.10)
butler_species <- c(
    "small_tortoiseshell",
    "orange_tip",
    "ringlet",
    "green-veined_white",
    "small_white",
    "holly_blue",
    "small_heath",
    "marsh_fritillary",
    "brimstone",
    "peacock",
    "wall_brown",
    "small_copper",
    "meadow_brown",
    "marbled_white",
    "large_skipper",
    "speckled_wood",
    "large_white",
    "comma",
    "common_blue",
    "gatekeeper",
    "white-letter_hairstreak",
    "brown_hairstreak",
    "essex_skipper",
    "small_skipper"
)
butler_data <- data.frame(butler_species, butler_risk)
butler_sorted <- butler_data[order(butler_data$butler_species),]

butler_sorted$my_risk <- round(risk$total_risk, 2)
butler_sorted$same <- butler_sorted$butler_risk == butler_sorted$my_risk
butler_sorted$diff <- butler_sorted$butler_risk - butler_sorted$my_risk
butler_sorted




```