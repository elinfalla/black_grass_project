---
title: "Farmland Biodiversity Health Index - <br> Mammal Risk Scores"
author: "Elin Falla"
output:
  html_document: default
  pdf_document: default
  word_document: default
fontsize: 11pt
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction  
This script calculates risk scores associated with changes to farm management, for **butterfly** species reliant on farmland.  

**Note:** the script needs at least 2 species inputted to run.

The method is from **Butler, S. J. et al.** 'A cross-taxonomic index for quantifying the health of farmland biodiversity.' J. Appl. Ecol. 46, 1154-1162 (2009) https://doi.org/10.1111/j.1365-2664.2009.01709.x  

## Set-up
### Load packages
```{r load-packages, message=FALSE}

rm(list = ls()) # clear env
library(readxl) # for reading in Excel sheets
library(tidyverse) # for data manipulation

```

### Read in required datasets  
Load datasets and replace all NAs with 0s.  
``` {r read-in-data}

# farm management strategies
man_strats <- read_xlsx("change.xlsx", 5) 

# butterfly requirements matrix data
butterfly <- read_xlsx("Butterfly matrix.xlsx", skip = 3) 

# forage plant locations
plant_locs <- read_xlsx("forage_plant_location.xlsx", na="NA")
plant_locs <- plant_locs[,-6]  # remove 'cropped area' column as not needed
#plant_locs <- plant_locs[is.na(plant_locs$riparian) == F,]  # remove NA rows, as this means the species isn't relevant to butterflies (bees only)

# butterfly forage plants
butterfly_plants <- read_xlsx("butterfly_forage_plants.xlsx")

# replace NAs with 0s in all datasets
man_strats <- man_strats %>% 
  mutate_all(~replace(., is.na(.), 0))

butterfly <- butterfly %>% 
  mutate_all(~replace(., is.na(.), 0))

plant_locs <- plant_locs %>% 
  mutate_all(~replace(., is.na(.), 0))

butterfly_plants <- butterfly_plants %>%
  mutate_all(~replace(., is.na(.), 0))
```

### Write function to create separate adult and larval datasets
``` {r sep-a-l}
separate_lifestages <- function(data) {
  
  ## Function to create separate datasets for adults and larvae
  
  if ("Lifestage" %in% colnames(data)) {  # this is the case for the butterfly forage plants matrix
    adults <- data[data$Lifestage == "a",]
    larvae <- data[data$Lifestage == "l",]
  }
  else {  # for the butterfly requirements matrix
    adults <- data %>%
    select(contains("Ad_"))
    
    # rename cols to   not include "Ad_"
    colnames(adults) <- gsub(pattern = "Ad_", replacement = "", colnames(adults)) 

    larvae <- data %>%
    select(contains("L_"))
    
    # rename cols to not include "L_"
    colnames(larvae) <- gsub(pattern = "L_", replacement = "", colnames(larvae))  
  }
  
  return(list(adults, larvae))
}
```
## Calculate $P_t$ (for adults, $P_{ta}$, and larvae, $P_{tl}$)

### Calculate $G$ and $H$
$G$ = number of generations across all activity periods (ie. number of generations per year)
$H$ = number of habitat components used by the species 


how many diff gens of adults/larvae in a year - just the generations column in butterfly matrix

``` {r calc-Ga-Gl}
calculate_Ga_Gl_Ha_Hl <- function(data) {

  #separate the adult and larval lifestages into separate dataframes (in order to loop over them)
  lifestages <- separate_lifestages(data)
  
  # create output dataframe
  output <- data.frame(Ha = rep(NA, nrow(data)),
                       Hl = rep(NA, nrow(data)),
                       Ga = rep(NA, nrow(data)),
                       Gl = rep(NA, nrow(data)))
  
  # calculate G and H for both adults and larvae
  for (i in 1:length(lifestages)) {
    
    # calculate H
    output[,i] <- lifestages[[i]] %>%
      select(hab_start : hab_end) %>%
      rowSums(.)
 
    # calculate G (select generations col of respective df)
    output[,i+2] <- lifestages[[i]] %>%
      select(generations)
  }
    
  return(output)
}
```

test G + H func:
``` {r test-GH}
calculate_Ga_Gl_Ha_Hl(butterfly)

```

### Calculate $G_t$
$G_t$ = number of generations of a species active in the activity periods affected

Here, 'strat' is a single management strategy - i.e. one row of the management strategy dataframe.

number of each gens foraging habitats affected
``` {r calc-Gta-Gtl}
calculate_Gta_Gtl <- function(data, strat) {
  
  # create separate adult and larvae dataframes
  lifestages <- separate_lifestages(data)
  
  # select relevant cols of strat
  activity_effects <- strat %>%
    select(activity_start : activity_end) %>%
    select(-c(activity_start, activity_end)) # remove start and end cols
  
  # create output dataframe
  output <- data.frame(Gta = rep(NA, nrow(data)),
                       Gtl = rep(NA, nrow(data)))
  
  # calculate Gt for both adults and larvae
  for (i in 1:length(lifestages)) {
    
    activity <- lifestages[[i]] %>%
      select(activity_start : activity_end) %>%
      select(-c(activity_start, activity_end))
  
  # Check columns of diets_habs and strat are the same (if not aligned, overlap calculation will not be correct)
  aligned <- identical(colnames(activity), colnames(activity_effects))
  
  if (aligned == F) {
    warning(paste0("WARNING: Butterfly data and management strategy columns do not align/are not the same - Gt calculations will be incorrect. Lifestage = ", i, ", 1=adult, 2=larvae"))
  }
  
  # find overlap
  overlap <- t(apply(activity, 1, function(row) row & activity_effects)) # NOTE: THIS ASSUMES THE COLUMNS ALIGN
  
  # sum rows to find Gt and store in output dataframe
  output[,i] <- rowSums(overlap)
  
  }
  
  return(output)
  
}
```

test calc Gt:
``` {r test-Gt}
calculate_Gta_Gtl(butterfly, man_strats[5,])[12,]
```

### Calculate Pt
Pta = Gta/(Ga*Ha)
Ptl = Gtl/(Gl*Hl)

``` {r calc-Pt}
calculate_Pta_Ptl <- function(data, strat) {
  
  G_H <- calculate_Ga_Gl_Ha_Hl(data)
  Ga <- G_H$Ga
  Gl <- G_H$Gl
  Ha <- G_H$Ha
  Hl <- G_H$Hl
  
  Gt <- calculate_Gta_Gtl(data, strat)
  Gta <- Gt$Gta
  Gtl <- Gt$Gtl
  
  # CALCULATE Pta
  Pta = Gta / (Ga * Ha)
  
  # replace infinite or NA values with 0
  Pta <- 
  ifelse(
    is.nan(Pta) | is.infinite(Pta) == T,  # test
    0, # if yes
    Pta  # if no
  )

  # CALCULATE Ptl
  Ptl = Gtl / (Gl * Hl)
  
  # replace infinite or NA values with 0
  Ptl <- 
  ifelse(
    is.nan(Ptl) | is.infinite(Ptl) == T,  # test
    0, # if yes
    Ptl  # if no
  )
  
  return(data.frame(Pta, Ptl))
}
```

``` {r or-cols-func}
apply_or_to_cols <- function(data) {
  
  # if data isn't a dataframe, return it
  if (is.data.frame(data) == F) {
    return(data)
  }
  # if data has only 1 column, return it
  if (ncol(data) <= 1) {
    return(data)
  }
  
  result <- data[,1]  # set first column as current column
  
  # use or operator across all columns to find all non-zero instances, put into a single col
    for (i in 2:ncol(data)) {
      result <- result | data[,i]
    }
  
  return(result)
  
}
```

## Calculate $F_t$ (for $a$ and $l$)

### Calculate $F$
$F$ = points of coincidence between species habitat use and the location of its forage plants 

Butterflies have long tongues, so adults can forage on any plant in the habitat(s) they occupy. Therefore, Fa (F for adults) will just be the total number of forage plants that are found in the species habitat(s).

Larvae have much more specific plant forage families.

``` {r calc-Fl-Fa}
# calculate_Fa_Fl <- function(data, plant_locs) {
#   
#   # PUT IN ALIGNMENT CHECKS - OR JUST CHECK THE COLS ARE THE SAME AND MATCH THE COLUMNS UP?
# 
#   # CALCULATE Fl
#   larval_plants <- data %>%
#     select(Aquifoliaceae : Violaceae)  
#   Fl <- rowSums(larval_plants)
#   
#   # CALCULATE Fa
#   # remove Poaceae (grasses) from plant species in plant_locs as adults don't forage on them
#   plant_locs <- plant_locs[plant_locs$plantfamily != "Poaceae",]
#   plant_locs <- plant_locs[,-1] # remove species name col of plant locs (so columns align with habs)
#   
#   # initialise output
#   Fa <- 0
#   
#   # subset butterfly data to just habitat cols
#   habs <- data %>% 
#     select(Ad_H_hab:Ad_R_hab)
# 
#   # calculate Fa for every species (ie. every row in habs dataframe)
#   for (i in 1:nrow(habs)) {
#     
#     locs <- plant_locs[,which(habs[i,] == 1)] # extract cols of plant_locs where butterfly habs=1
#     
#     all_plants <- apply_or_to_cols(locs)
#       
#     # Fa is total number of plants = sum the result
#     Fa[i] <- sum(all_plants)
#    
#   }
#   return(data.frame(Fa, Fl))
# }
```

``` {r test-Al}
# calculate_Fa_Fl(butterfly, plant_locs)


```


### Calculate $A$
$A$ = number of points of coincidence between the impact on and speciesâ€™ use of forage plant families

``` {r calc-Al-Aa}
calculate_Aa_Al <- function(data, plants, plant_locs, strat) {
  
  # PUT IN CHECK THAT COLUMNS ALIGN
  
  # separate adults and larvae cols of butterfly data and butterfly plants data
  lifestages_butterfly <- separate_lifestages(data)
  lifestages_plants <- separate_lifestages(plants)
  
  # select hab + damp cols of change data
  hab_effects <- strat %>%
    select(hab_start:hab_end, damp_start:damp_end)

  # pull plant names from plant_locs and plants, to check they are the same
  plant_locs_names <- plant_locs %>% pull(plantfamily)
  plants_names <- colnames(plants %>% 
                             select(species_start:species_end) %>% 
                             select(-c(species_start, species_end)))
  
  # check plant names are the same, print warning if not
  if (identical(plant_locs_names, plants_names) == F) {
    warning("WARNING: columns of butterfly forage plants are not the same as rows of plant locations data, i.e. plant species are not the same. Calculations may be incorrect.")
    
    print("Cols of butterfly plant data:")
    print(paste(plants_names))
    print(paste("Rows of plant locations data:", plant_locs_names))
  }
  
  # initialise output dataframe
  output <- data.frame(Fa = rep(NA, nrow(data)),
                       Fl = rep(NA, nrow(data)),
                       Aa = rep(NA, nrow(data)),
                       Al = rep(NA, nrow(data)))

  # calculate F and A for each lifestage (adults and larvae)
  for (lifestage in 1:length(lifestages_butterfly)) {

    # subset butterfly requirements data to habitat and damp cols
    habs <- lifestages_butterfly[[lifestage]] %>%
      select(hab_start:hab_end, damp_start:damp_end)

    
    # select plant species cols from butterfly forage plants data
    butterfly_plants <- lifestages_plants[[lifestage]] %>%
    select(species_start : species_end) %>%
    select(-c(species_start, species_end)) # remove marker cols
    
    # find overlap between species habitat use and effects on habitat
    overlap <- as.data.frame(t(apply(habs, 1, function(row) row & hab_effects)))
    colnames(overlap) <- colnames(habs)
  
    # split effects on species into general and damp effects
 
    general_effects <- overlap %>% 
      select(hab_start : hab_end) %>%
      select(-c(hab_start, hab_end))  # remove marker cols
    
    damp_effects <- overlap %>% 
      select(damp_start : damp_end) %>%
      select(-c(damp_start, damp_end))  # remove marker cols
    
    # calculate A and F for each species
    for(species in 1:nrow(habs)) {

      sp_general_effects <- general_effects[species,]
      sp_damp_effects <- damp_effects[species,]
      

      # remove species name col of plant locs (so columns align with habs)
      no_name_plant_locs <- plant_locs[,-1] 
     
      # subset plant locs to only include plants the species forages on
      sp_plant_locs <- no_name_plant_locs[which(butterfly_plants[species,] == 1),]
    
      # if species has no forage plants, print warning and set A and F to 0
      if (nrow(sp_plant_locs) == 0) { 
        warning(paste("WARNING: Species", species, "has 0 forage plants. Al = 0
                      "))
        output[species, lifestage] <- 0
        next  # go to next iteration of for loop
      }

      # CALCULATE F
      
      # subet habitat to current species
      sp_habs <- habs %>%
        select(hab_start : hab_end) %>%
        select(-c(hab_start, hab_end))
      sp_habs <- sp_habs[species,]
      
      all_forage_plants <- sp_plant_locs[,which(sp_habs != 0)]
      output[species, lifestage] <- sum(all_forage_plants) # don't include final col (likesdamp col)
 
      # CALCULATE A
      
      # find all plants affected by general hab effects
      sp_effects <- list(sp_general_effects, sp_damp_effects)
      plants_affected <- c(NA, NA)
      
      for (effect in 1:length(sp_effects)) {

        plant_locs_affected <- sp_plant_locs[,which(sp_effects[[effect]] != 0)]

        if (ncol(plant_locs_affected) == 0) {
 
          plants_affected[effect] <- 0
          next  # if no plants affected, skip to next iteration (next effect)
        }
        
        if (effect == 2) {  # if damp effects, need to subset to only damp plants
          damp_plants_affected <- plant_locs_affected[sp_plant_locs$likesdamp == "yes",]

          plants_affected[effect] <- sum(damp_plants_affected)
        }
        else {
          plants_affected[effect] <- sum(plant_locs_affected)
        }
        
      }
      total_plants_affected <- sum(plants_affected)
      
      # plant_locs_affected <- sp_plant_locs[,which(sp_general_effects != 0)]
      # if (ncol(plant_locs_affected) == 0) {
      #   plant_locs_affected <- 0
      # }
      # plants_affected <- sum(plant_locs_affected)
      # 
      # # find all plants affected by damp plant effects
      # damp_plant_locs_affected <- sp_plant_locs[,which(sp_damp_effects != 0)]
      # if (ncol(damp_plant_locs_affected) == 0) {
      #   damp_plant_locs_affected <- 0
      # }
      # damp_plants_affected <- damp_plant_locs_affected[sp_plant_locs$likesdamp == "yes",]
      # damp_plants_affected <- sum(damp_plants_affected)
      # 
      # # find A - sum of total plants affected
      # total_plants_affected <- sum(plants_affected, damp_plants_affected)
    
      output[species, lifestage+2] <- total_plants_affected
    }
  }
  return(output)
}
```

``` {r test-Fa}
calculate_Aa_Al(butterfly, butterfly_plants, plant_locs, man_strats[2,])
```

### Calculate $F_t$
 
``` {r calc-Ft}
calculate_Fta_Ftl <- function(data, plant_locs, strat) {
  F <- calculate_Fa_Fl(data, plant_locs)
  Fa <- F$Fa
  Fl <- F$Fl

  A <- calculate_Aa_Al(data, plant_locs, strat)
  Aa <- A$Aa
  Al <- A$Al

  # CALCULATE Fta
  Fta <- Aa / Fa

  # replace infinite or NA values with 0
  Fta <- 
  ifelse(
    is.nan(Fta) | is.infinite(Fta) == T,  # test
    0, # if yes
    Fta  # if no
  )
  
  # CALCULATE Ftl
  Ftl <- Al / Fl

  # replace infinite or NA values with 0
  Ftl <- 
  ifelse(
    is.nan(Ftl) | is.infinite(Ftl) == T,  # test
    0, # if yes
    Ftl  # if no
  )

  return(data.frame(Fta, Ftl))
}
```

``` {r test-Ft}
calculate_Fta_Ftl(butterfly, plant_locs, man_strats[1,])
```

## Calculate risk score
``` {r calc-riskscore}
calc_butterfly_riskscore <- function(data, plant_locs, strategies) {
  
  # initialise riskscores dataframe, rows are species, cols are strategies
  riskscores <- data.frame(matrix(NA, 
                                  nrow = nrow(data), 
                                  ncol = nrow(strategies) + 1)) # +1 to add in species names
  # put species names in first col
  riskscores[,1] <- data[,1]
  
  # name columns of riskscores according to strategies
  strat_names <- strategies %>% pull(agric_change)
  colnames(riskscores) <- c("species", strat_names)
  
  # extract reliance (R) values for adults and larvae from butterfly data
  R <- data %>% 
    select(contains("reliance"))
  Ra <- R %>%
    select(contains("Ad_"))
  Rl <- R %>%
    select(contains("L_"))
  
  # CALCULATE RISK SCORES per strategy and store in riskscores dataframe
  for (strat in 1:nrow(strategies)) {
    
    Pt <- calculate_Pta_Ptl(data, strategies[strat,])
    Pta <- Pt$Pta
    Ptl <- Pt$Ptl
    
    Ft <- calculate_Fta_Ftl(data, plant_locs, strategies[strat,])
    Fta <- Ft$Fta
    Ftl <- Ft$Ftl
    
    riskscores[,strat+1] <- ((Pta + Fta) / Ra) + ((Ptl + Ftl) / Rl)
  }
  
  # calculate total risk for each species by summing risk across all strategies (if more than one strategy)
  if (nrow(strategies) > 1) {
    riskscores$total_risk <- rowSums(riskscores[,-1])
  }
  
  return(riskscores)
}
  
```

``` {r test-riskscore}
calc_butterfly_riskscore(butterfly, plant_locs, man_strats)
```