---
title: "Farmland Biodiversity Health Index - <br> Mammal Risk Scores"
author: "Elin Falla"
output:
  html_document: default
  pdf_document: default
  word_document: default
fontsize: 11pt
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction  
This script calculates risk scores associated with changes to farm management, for **butterfly** species reliant on farmland.  

**Note:** the script needs at least 2 species inputted to run.

The method is from **Butler, S. J. et al.** 'A cross-taxonomic index for quantifying the health of farmland biodiversity.' J. Appl. Ecol. 46, 1154-1162 (2009) https://doi.org/10.1111/j.1365-2664.2009.01709.x  

## Set-up
### Load packages
```{r load-packages, message=FALSE}

rm(list = ls()) # clear env
library(readxl) # for reading in Excel sheets
library(tidyverse) # for data manipulation

```

### Read in required datasets  
Load datasets and replace all NAs with 0s.  
``` {r read-in-data}

# farm management strategies
man_strats <- read_xlsx("change.xlsx", 5) 

# butterfly matrix data
butterfly <- read_xlsx("Butterfly matrix.xlsx", skip = 3) 

# forage plant locations
plant_locs <- read_xlsx("forage_plant_location.xlsx", na="NA")
plant_locs <- plant_locs[,-6]  # remove 'cropped area' column as not needed
plant_locs <- plant_locs[is.na(plant_locs$riparian) == F,]  # remove NA rows, as this means the species isn't relevant to butterflies (bees only)

# replace NAs with 0s in both datasets
man_strats <- man_strats %>% 
  mutate_all(~replace(., is.na(.), 0))

butterfly <- butterfly %>% 
  mutate_all(~replace(., is.na(.), 0))

plant_locs <- plant_locs %>% 
  mutate_all(~replace(., is.na(.), 0))
```

### Write function to create separate adult and larval datasets
``` {r sep-a-l}
separate_lifestages <- function(data) {
  
  # create separate dataframes for adults and larvae
  adults <- data %>%
    select(contains("Ad_"))
  colnames(adults) <- gsub(pattern = "Ad_", replacement = "", colnames(adults))  # rename cols to not include "Ad_"

  larvae <- data %>%
    select(contains("L_"))
  colnames(larvae) <- gsub(pattern = "L_", replacement = "", colnames(larvae))  # rename cols to not include "L_"
 
  return(list(adults, larvae))
}
```
## Calculate $P_t$ (for adults, $P_{ta}$, and larvae, $P_{tl}$)

### Calculate $G$ and $H$
$G$ = number of generations across all activity periods (ie. number of generations per year)
$H$ = number of habitat components used by the species 

REMEMBER TO FIX NUMBER OF GENERATIONS IN BUTTERFLY MATRIX

how many diff gens of adults/larvae in a year - just the generations column in butt matrix

``` {r calc-Ga-Gl}
calculate_Ga_Gl_Ha_Hl <- function(data) {

  #separate the adult and larval lifestages into separate dataframes (in order to loop over them)
  lifestages <- separate_lifestages(data)
  
  # create output dataframe
  output <- data.frame(Ha = rep(NA, nrow(data)),
                       Hl = rep(NA, nrow(data)),
                       Ga = rep(NA, nrow(data)),
                       Gl = rep(NA, nrow(data)))
  
  # calculate G and H for both adults and larvae
  for (i in 1:length(lifestages)) {
    
    # calculate H
    output[,i] <- lifestages[[i]] %>%
      select(H_hab : R_hab) %>%
      rowSums(.)
 
    # calculate G (select generations col of respective df)
    output[,i+2] <- lifestages[[i]] %>%
      select(generations)
  }
    
  return(output)
}
```

test G + H func:
``` {r test-GH}
calculate_Ga_Gl_Ha_Hl(butterfly)

```

### Calculate $G_t$
$G_t$ = number of generations of a species active in the activity periods affected

Here, 'strat' is a single management strategy - i.e. one row of the management strategy dataframe.

number of each gens foraging habitats affected
``` {r calc-Gta-Gtl}
calculate_Gta_Gtl <- function(data, strat) {
  
  # create separate adult and larvae dataframes
  lifestages <- separate_lifestages(data)
  
  # select relevant cols of strat
  activity_effects <- strat %>%
      select(H_early : R_late)
  
  # create output dataframe
  output <- data.frame(Gta = rep(NA, nrow(data)),
                       Gtl = rep(NA, nrow(data)))
  
  # calculate Gt for bot h adults and larvae
  for (i in 1:length(lifestages)) {
    
    activity <- lifestages[[i]] %>%
      select(H_early : R_late)
  
  # Check columns of diets_habs and strat are the same (if not aligned, overlap calculation will not be correct)
  aligned <- identical(colnames(activity), colnames(activity_effects))
  
  if (aligned == F) {
    warning(paste0("WARNING: Butterfly data and management strategy columns do not align/are not the same - Gt calculations will be incorrect. Iteration = ", i, ", 1=adult, 2=larvae"))
  }
  
  # find overlap
  overlap <- t(apply(activity, 1, function(row) row & activity_effects)) # NOTE: THIS ASSUMES THE COLUMNS ALIGN
  
  # sum rows to find Gt and store in output dataframe
  output[,i] <- rowSums(overlap)
  
  }
  
  return(output)
  
}
```

test calc Gt:
``` {r test-Gt}
calculate_Gta_Gtl(butterfly, man_strats[5,])[12,]
```

### Calculate Pt
Pta = Gta/(Ga*Ha)
Ptl = Gtl/(Gl*Hl)

``` {r calc-Pt}
calculate_Pta_Ptl <- function(data, strat) {
  
  G_H <- calculate_Ga_Gl_Ha_Hl(data)
  Ga <- G_H$Ga
  Gl <- G_H$Gl
  Ha <- G_H$Ha
  Hl <- G_H$Hl
  
  Gt <- calculate_Gta_Gtl(data, strat)
  Gta <- Gt$Gta
  Gtl <- Gt$Gtl
  
  # CALCULATE Pta
  Pta = Gta / (Ga * Ha)
  
  # replace infinite or NA values with 0
  Pta <- 
  ifelse(
    is.nan(Pta) | is.infinite(Pta) == T,  # test
    0, # if yes
    Pta  # if no
  )

  # CALCULATE Ptl
  Ptl = Gtl / (Gl * Hl)
  
  # replace infinite or NA values with 0
  Ptl <- 
  ifelse(
    is.nan(Ptl) | is.infinite(Ptl) == T,  # test
    0, # if yes
    Ptl  # if no
  )
  
  return(data.frame(Pta, Ptl))
}
```

``` {r or-cols-func}
apply_or_to_cols <- function(data) {
  
  # if data isn't a dataframe, return it
  if (is.data.frame(data) == F) {
    return(data)
  }
  # if data has only 1 column, return it
  if (ncol(data) <= 1) {
    return(data)
  }
  
  result <- data[,1]  # set first column as current column
  
  # use or operator across all columns to find all non-zero instances, put into a single col
    for (i in 2:ncol(data)) {
      result <- result | data[,i]
    }
  
  return(result)
  
}
```

## Calculate Ft (for a and l)
### Calculate A
$A$ = number of points of coincidence between the impact on and speciesâ€™ use of forage plant families
### Calculate F
$F$ = points of coincidence between species habitat use and the location of its forage plants

Butterflies have long tongues, so adults can forage on any plant in the habitat(s) they occupy. Therefore, Fa (F for adults) will just be the total number of forage plants that are found in the species habitat(s).

for adults: SUBSET OUT POACAE

FOR LARVAE: need to see if diff poacae species grow in different habitats or not
``` {r calc-Fa-Aa}
calculate_Fa_Aa <- function(data, plant_locs, strat) {
  
  # PUT IN CHECK THAT COLUMNS ALIGN
  
  # remove Poaceae (grasses) from plant species in plant_locs as adults don't forage on them
  plant_locs <- plant_locs[plant_locs$plantfamily != "Poaceae",]
  
  # remove species name col of plant locs (so columns align with habs)
  plant_locs <- plant_locs[,-1]
  
  # subset butterfly data to habitat (+ damp plants) columns
  habs <- data %>%
    select(Ad_H_hab:Ad_R_hab, Ad_H_damp:Ad_R_damp)

  # select hab + damp cols of change data
  hab_effects <- strat %>%
    select(H_hab:R_hab, H_damp:R_damp)

  # initialise output
  Aa <- 0
  
  # find overlap between species habitat use and effects on habitat
  overlap <- as.data.frame(t(apply(habs, 1, function(row) row & hab_effects)))
  colnames(overlap) <- colnames(hab_effects)
  
  # split effects on species into general and damp effects
  general_effects <- overlap %>% select(H_hab:R_hab)
  damp_effects <- overlap %>% select(H_damp:R_damp)

  # calculate Aa for each species
  for(species in 1:nrow(overlap)) {

    sp_general_effects <- general_effects[species,]
    sp_damp_effects <- damp_effects[species,]

    # find all plants affected by general hab effects
    plant_locs_affected <- plant_locs[,which(sp_general_effects != 0)]
    if (ncol(plant_locs_affected) == 0) {
      plant_locs_affected <- 0
    }
    plants_affected <- apply_or_to_cols(plant_locs_affected)
    
    # find all plants affected by damp plant effects
    damp_plant_locs_affected <- plant_locs[,which(sp_damp_effects != 0)]
    if (ncol(damp_plant_locs_affected) == 0) {
      damp_plant_locs_affected <- 0
    }
    damp_plants_affected <- apply_or_to_cols(damp_plant_locs_affected)
    damp_plants_affected <- damp_plants_affected & plant_locs$likesdamp == "yes"

    # find Aa - total plants affected
    total_plants_affected <- plants_affected | damp_plants_affected

    Aa[species] <- sum(total_plants_affected)
    
  }

  # initialise output arrays
  Fa <- 0
  
  # subset habs to just habitats (not damp plants)
  habs <- habs %>% select(Ad_H_hab:Ad_R_hab)
    
  # calculate Fa for every species (ie. every row in habs dataframe
  for (i in 1:nrow(habs)) {
    
    locs <- plant_locs[,which(habs[i,] == 1)] # extract cols of plant_locs for which butterfly habs=1
    
    all_plants <- apply_or_to_cols(locs)
      
    # Fa is total number of plants = sum the result
    Fa[i] <- sum(all_plants)
   
  }
  print("ere")
  return(data.frame(Fa, Aa))
}
```

``` {r test-Fa}
calculate_Fa_Aa(butterfly, plant_locs, man_strats[6,])
```


calculate Al and Fl  
does the overlap (Al) have to take into account where the species are - or if there's overlap can i assume that all species it feeds on are affected? probs not  
``` {r calc-Fl-Al}
calculate_Fl_Al <- function(data, plant_locs, strat) {
  
  # PUT IN ALIGNMENT CHECKS
  
  larval_plants <- data %>%
    select(Aquifoliaceae : Violaceae)
  
  larval_habs <- data %>%
    select(L_H_hab : L_R_hab, L_H_damp : L_R_damp)
  
  hab_effects <- strat %>%
    select(H_hab : R_hab, H_damp : R_damp)
  
  Fl <- rowSums(larval_plants)
  
  # remember the species are subsetted when the dataset is read in, will have to change this if want additional larval species
  
  overlap <- data.frame(t(apply(larval_habs, 1, function(row) row & hab_effects)))
  colnames(overlap) <- colnames(hab_effects)
  
  # split effects on species into general and damp effects
  general_effects <- overlap %>% select(H_hab:R_hab)
  damp_effects <- overlap %>% select(H_damp:R_damp)
  
  # initialise Al
  Al <- 0
  
  for (species in 1:nrow(larval_habs)) {
    
    sp_general_effects <- general_effects[species,]
    sp_damp_effects <- damp_effects[species,]

    l_plant_locs <- plant_locs[which(larval_plants[species,] == 1),]
    l_likes_damp <- l_plant_locs[,"likesdamp"]
    print(l_likes_damp)
    if (nrow(l_plant_locs) == 0) {
      warning(paste("WARNING: Species", species, "has 0 forage plants. Cannot calculate Al"))
      Al[species] <- 0
      next  # go to next iteration of for loop
    }
    
    l_plant_locs <- l_plant_locs[,-c(1,7)]  # remove names and 'likesdamp' cols so aligns


    l_plant_locs_affected <- l_plant_locs[,which(sp_general_effects != 0)]
    
    if (ncol(l_plant_locs_affected) == 0) {
      l_plant_locs_affected <- 0
    }
    
    # or cols together to get all plant species affected
    general_plants_affected <- apply_or_to_cols(l_plant_locs_affected)
    
    # do same for damp plants
    l_damp_plants_affected <- l_plant_locs[,which(sp_damp_effects != 0)]
    
    if (ncol(l_damp_plants_affected) == 0) {
      l_damp_plants_affected <- 0
    }
    # or cols together and select damp ones to get all damp plant species affected
    damp_plants_affected <- apply_or_to_cols(l_damp_plants_affected)

    damp_plants_affected <- damp_plants_affected & l_likes_damp$likesdamp == "yes"
  print("aaa")

    
    # get total species affected
    total_species_affected <- general_plants_affected | damp_plants_affected
    print("aaaa")
    Al[species] <- sum(total_species_affected)
print("fuck")
  }
  
  return(data.frame(Fl, Al))
}
```

``` {r test-Al}
calculate_Fl_Al(butterfly, plant_locs, man_strats[4,])
```
